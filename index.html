<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EV Gravity Logger</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#0a0a0f',
                            dark: '#13131f',
                            primary: '#00f0ff',
                            secondary: '#7000df',
                            accent: '#ff003c',
                            glass: 'rgba(255, 255, 255, 0.05)',
                            glassBorder: 'rgba(255, 255, 255, 0.1)',
                            text: '#e0e0e0',
                            dim: '#8888aa'
                        }
                    },
                    fontFamily: {
                        display: ['Orbitron', 'sans-serif'],
                        tech: ['Rajdhani', 'sans-serif'],
                        body: ['Noto Sans JP', 'sans-serif'],
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #0a0a0f;
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: none;
            /* Prevent browser zooming/panning */
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom scrollbar for lists */
        .cyber-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .cyber-scroll::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .cyber-scroll::-webkit-scrollbar-thumb {
            background: #00f0ff;
            border-radius: 2px;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(19, 19, 31, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 240, 255, 0.2);
            color: #00f0ff;
            font-family: 'Rajdhani', sans-serif;
            transition: all 0.2s;
        }

        .glass-input:focus {
            border-color: #00f0ff;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
            outline: none;
        }

        /* Neon Text */
        .text-neon {
            text-shadow: 0 0 5px rgba(0, 240, 255, 0.7), 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .text-neon-pink {
            text-shadow: 0 0 5px rgba(255, 0, 60, 0.7), 0 0 10px rgba(255, 0, 60, 0.5);
        }

        /* Odometer Animation */
        .odometer-digit {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Button Press Effect */
        .cyber-btn:active {
            transform: scale(0.95);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Mobile Viewport Fix */
        .h-dvh {
            height: 100vh;
            /* Fallback */
            height: 100dvh;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Constants & Config ---
        const PRE_CONFIGURED_GAS_URL = "https://script.google.com/macros/s/AKfycby6A4grTpYFeWSNAcmWwtqYqG7fVEThhYhXZz6qj4i-C4knWEVY3Ka8TOSnoUPpUUu4/exec";
        const STORAGE_KEY_DATA = "ev_gravity_data_v1";
        const STORAGE_KEY_SETTINGS = "ev_gravity_settings_v1";
        const STORAGE_KEY_SESSION = "ev_gravity_session_v1";
        const STORAGE_KEY_LOCATIONS = "ev_gravity_locations_v1";

        // --- Utils ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getTimestamp = () => new Date().toISOString();
        // Format for datetime-local input (YYYY-MM-DDThh:mm)
        const getLocalISOString = (date = new Date()) => {
            const offset = date.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(date - offset)).toISOString().slice(0, 16);
            return localISOTime;
        };
        const formatDate = (isoString) => {
            const d = new Date(isoString);
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        };
        const getRandomColor = () => {
            const colors = ['#00f0ff', '#7000df', '#ff003c', '#e0e0e0', '#0a0a0f'];
            return colors[Math.floor(Math.random() * colors.length)];
        };

        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { Engine, Render, Runner, World, Bodies, Body, Mouse, MouseConstraint, Composite, Events } = Matter;

        // --- Hooks ---
        const useRepeater = (callback, delay = 500, interval = 100) => {
            const timeoutIdRef = useRef(null);
            const intervalIdRef = useRef(null);
            const isRunningRef = useRef(false);

            const stop = useCallback(() => {
                isRunningRef.current = false;
                if (timeoutIdRef.current) {
                    clearTimeout(timeoutIdRef.current);
                    timeoutIdRef.current = null;
                }
                if (intervalIdRef.current) {
                    clearInterval(intervalIdRef.current);
                    intervalIdRef.current = null;
                }
            }, []);

            const start = useCallback(() => {
                if (isRunningRef.current) return; // Prevent double-start

                stop(); // Clean any existing timers
                isRunningRef.current = true;

                callback(); // Execute immediately

                timeoutIdRef.current = setTimeout(() => {
                    if (!isRunningRef.current) return;
                    intervalIdRef.current = setInterval(() => {
                        if (!isRunningRef.current) {
                            stop();
                        } else {
                            callback();
                        }
                    }, interval);
                }, delay);
            }, [callback, delay, interval, stop]);

            useEffect(() => {
                return stop; // Cleanup on unmount
            }, [stop]);

            return { start, stop };
        };

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Components ---

        // 1. Physics World (Background) âš›ï¸
        const PhysicsBackground = ({ onEngineReady }) => {
            const sceneRef = useRef(null);
            const engineRef = useRef(null);
            const renderRef = useRef(null);
            const runnerRef = useRef(null);

            useEffect(() => {
                // Setup Matter.js
                const engine = Engine.create();
                const world = engine.world;
                engineRef.current = engine;

                const render = Render.create({
                    element: sceneRef.current,
                    engine: engine,
                    options: {
                        width: window.innerWidth,
                        height: window.innerHeight,
                        background: 'transparent',
                        wireframes: false,
                        pixelRatio: window.devicePixelRatio
                    }
                });
                renderRef.current = render;

                // Walls
                const updateWalls = () => {
                    Composite.clear(world, false, true); // Keep bodies, remove constraints/walls if tagged
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    const wallOptions = { isStatic: true, render: { fillStyle: '#13131f' } };

                    World.add(world, [
                        Bodies.rectangle(width / 2, height + 50, width, 100, wallOptions), // Floor
                        Bodies.rectangle(-50, height / 2, 100, height * 4, wallOptions), // Left
                        Bodies.rectangle(width + 50, height / 2, 100, height * 4, wallOptions) // Right
                    ]);
                };
                updateWalls();

                // Mouse Control (The "Antigravity" Experience)
                const mouse = Mouse.create(render.canvas);
                const mouseConstraint = MouseConstraint.create(engine, {
                    mouse: mouse,
                    constraint: {
                        stiffness: 0.2, // Smoother grab
                        render: { visible: false }
                    }
                });
                World.add(world, mouseConstraint);

                // Allow scrolling on non-canvas elements (pass through events)
                mouse.element.removeEventListener("mousewheel", mouse.mousewheel);
                mouse.element.removeEventListener("DOMMouseScroll", mouse.mousewheel);

                // Runner
                const runner = Runner.create();
                runnerRef.current = runner;
                Runner.run(runner, engine);
                Render.run(render);

                // Initial callback
                if (onEngineReady) onEngineReady(engine);

                // Resize Handler
                const handleResize = () => {
                    render.canvas.width = window.innerWidth;
                    render.canvas.height = window.innerHeight;
                    updateWalls();
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    Render.stop(render);
                    Runner.stop(runner);
                    if (render.canvas) render.canvas.remove();
                    window.removeEventListener('resize', handleResize);
                };
            }, []);

            return <div ref={sceneRef} className="fixed inset-0 z-0 pointer-events-auto" />;
        };

        // 2. Smart Input Components (Design System) ðŸŽ¨
        const RepeaterButton = ({ onClick, className, children }) => {
            const repeater = useRepeater(onClick);
            const hasStartedRef = useRef(false);

            const handlePointerDown = (e) => {
                e.preventDefault();
                if (hasStartedRef.current) return;
                hasStartedRef.current = true;
                repeater.start();
            };

            const handlePointerUp = (e) => {
                e.preventDefault();
                hasStartedRef.current = false;
                repeater.stop();
            };

            const handlePointerCancel = (e) => {
                e.preventDefault();
                hasStartedRef.current = false;
                repeater.stop();
            };

            return (
                <button
                    onPointerDown={handlePointerDown}
                    onPointerUp={handlePointerUp}
                    onPointerCancel={handlePointerCancel}
                    onPointerLeave={handlePointerUp}
                    className={`${className} no-select touch-none`}
                    type="button"
                >
                    {children}
                </button>
            );
        };

        const SmartNumberInput = ({ label, value, unit, onChange, steps = [-10, -1, 1, 10], min = 0, max = 999999 }) => {
            const adjust = (delta) => {
                let next = parseFloat((value + delta).toFixed(1));
                if (next < min) next = min;
                if (next > max) next = max;
                onChange(next);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'ArrowUp' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    adjust(e.shiftKey ? steps[3] : steps[2]); // +10 or +1
                } else if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    adjust(e.shiftKey ? steps[0] : steps[1]); // -10 or -1
                }
            };

            return (
                <div className="flex flex-col gap-1 mb-2">
                    <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1">{label}</label>
                    <div
                        className="flex items-center justify-between glass-input rounded-lg p-1 focus-within:border-cyber-primary focus-within:shadow-[0_0_15px_rgba(0,240,255,0.2)]"
                        tabIndex="0"
                        onKeyDown={handleKeyDown}
                    >
                        {/* Minus Buttons */}
                        <div className="flex gap-1">
                            {steps.filter(s => s < 0).map(step => (
                                <RepeaterButton key={step} onClick={() => adjust(step)}
                                    className="cyber-btn h-10 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-accent font-bold hover:bg-cyber-accent/20 transition-colors">
                                    {step}
                                </RepeaterButton>
                            ))}
                        </div>

                        {/* Display (Editable) */}
                        <div className="flex items-baseline gap-1 flex-1 justify-center">
                            <input
                                type="number"
                                value={value}
                                onChange={(e) => onChange(parseFloat(e.target.value))}
                                className="w-20 bg-transparent text-2xl font-display text-cyber-primary text-center focus:outline-none appearance-none p-0"
                            />
                            <span className="text-xs text-cyber-dim font-tech">{unit}</span>
                        </div>

                        {/* Plus Buttons */}
                        <div className="flex gap-1">
                            {steps.filter(s => s > 0).map(step => (
                                <RepeaterButton key={step} onClick={() => adjust(step)}
                                    className="cyber-btn h-10 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-primary font-bold hover:bg-cyber-primary/20 transition-colors">
                                    +{step}
                                </RepeaterButton>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const DateTimeInput = ({ label, value, onChange }) => {
            return (
                <div className="flex flex-col gap-1 mb-4">
                    <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1">{label}</label>
                    <input
                        type="datetime-local"
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                        className="glass-input w-full rounded-lg p-3 text-xl font-display text-center text-cyber-primary"
                    />
                </div>
            );
        };

        const OdometerDigit = ({ value, onUp, onDown }) => {
            return (
                <div className="flex flex-col items-center gap-1">
                    <RepeaterButton onClick={onUp} className="cyber-btn p-1 text-cyber-primary hover:text-white transition-colors">
                        <Icon name="chevron-up" size={24} />
                    </RepeaterButton>
                    <div className="w-10 h-14 bg-black/80 border border-cyber-glassBorder rounded flex items-center justify-center overflow-hidden relative shadow-[inset_0_0_10px_rgba(0,0,0,0.8)]">
                        <div className="text-3xl font-display text-white z-10">{value}</div>
                        {/* Shine effect */}
                        <div className="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/10 to-transparent pointer-events-none"></div>
                    </div>
                    <RepeaterButton onClick={onDown} className="cyber-btn p-1 text-cyber-primary hover:text-white transition-colors">
                        <Icon name="chevron-down" size={24} />
                    </RepeaterButton>
                </div>
            );
        };

        const Odometer = ({ value, onChange }) => {
            // value is total km. Split into 6 digits.
            const digits = String(value).padStart(6, '0').split('').map(Number);

            const updateDigit = (index, delta) => {
                let newDigits = [...digits];
                let val = newDigits[index] + delta;
                if (val > 9) val = 0;
                if (val < 0) val = 9;
                newDigits[index] = val;

                const newValue = parseInt(newDigits.join(''));
                onChange(newValue);
            };

            return (
                <div className="flex flex-col gap-1 mb-4">
                    <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1">Odometer (km)</label>
                    <div className="glass-panel rounded-xl p-3 flex justify-center gap-2 bg-gradient-to-b from-cyber-dark/80 to-cyber-black/80">
                        {digits.map((d, i) => (
                            <OdometerDigit
                                key={i}
                                value={d}
                                onUp={() => updateDigit(i, 1)}
                                onDown={() => updateDigit(i, -1)}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // 3. Settings & History Components ðŸ‘¨â€ðŸ’»
        const SettingsModal = ({ isOpen, onClose, gasUrl, setGasUrl, locations, setLocations }) => {
            const [newLoc, setNewLoc] = useState({ name: '', voltage: 200, amperage: 15, kw: 3.0 });
            const [editingLocId, setEditingLocId] = useState(null);

            useEffect(() => {
                lucide.createIcons();
            });

            const handleSaveLocation = () => {
                if (!newLoc.name) return;

                if (editingLocId) {
                    // Update existing
                    setLocations(locations.map(l => l.id === editingLocId ? { ...newLoc, id: editingLocId } : l));
                    setEditingLocId(null);
                } else {
                    // Add new
                    setLocations([...locations, { ...newLoc, id: generateId() }]);
                }
                setNewLoc({ name: '', voltage: 200, amperage: 15, kw: 3.0 });
            };

            const startEdit = (loc) => {
                setNewLoc({ name: loc.name, voltage: loc.voltage, amperage: loc.amperage, kw: loc.kw });
                setEditingLocId(loc.id);
            };

            const cancelEdit = () => {
                setNewLoc({ name: '', voltage: 200, amperage: 15, kw: 3.0 });
                setEditingLocId(null);
            }

            const removeLocation = (id) => {
                setLocations(locations.filter(l => l.id !== id));
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="glass-panel w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl p-6 relative cyber-scroll">
                        <button onClick={onClose} className="absolute top-4 right-4 text-cyber-dim hover:text-white">
                            <Icon name="x" />
                        </button>
                        <h2 className="text-xl font-display text-cyber-primary mb-6 flex items-center gap-2">
                            <Icon name="settings" /> Settings
                        </h2>

                        <div className="mb-8">
                            <h3 className="text-sm font-bold text-white mb-2 flex items-center gap-2"><Icon name="map-pin" size={16} /> Charging Locations</h3>
                            <div className="space-y-2 mb-4">
                                {locations.map(loc => (
                                    <div key={loc.id} className={`flex justify-between items-center bg-white/5 p-2 rounded border transition-colors ${editingLocId === loc.id ? 'border-cyber-primary bg-cyber-primary/10' : 'border-white/10'}`}>
                                        <div>
                                            <div className="font-bold text-cyber-primary">{loc.name}</div>
                                            <div className="text-xs text-cyber-dim">{loc.voltage}V / {loc.amperage}A / {loc.kw}kW</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => startEdit(loc)} className="text-cyber-dim hover:text-white"><Icon name="edit-2" size={16} /></button>
                                            <button onClick={() => removeLocation(loc.id)} className="text-cyber-accent hover:text-white"><Icon name="trash-2" size={16} /></button>
                                        </div>
                                    </div>
                                ))}
                                {locations.length === 0 && <div className="text-xs text-cyber-dim italic">No locations added.</div>}
                            </div>

                            <div className="bg-black/40 p-3 rounded border border-white/10">
                                <div className="text-xs text-cyber-dim mb-2 uppercase">Add New Location</div>
                                <input type="text" placeholder="Name (e.g. Home)" value={newLoc.name} onChange={e => setNewLoc({ ...newLoc, name: e.target.value })} className="w-full glass-input rounded p-2 mb-2 text-sm" />
                                <div className="grid grid-cols-3 gap-2 mb-2">
                                    <input type="number" placeholder="V" value={newLoc.voltage} onChange={e => setNewLoc({ ...newLoc, voltage: Number(e.target.value) })} className="glass-input rounded p-2 text-sm" />
                                    <input type="number" placeholder="A" value={newLoc.amperage} onChange={e => setNewLoc({ ...newLoc, amperage: Number(e.target.value) })} className="glass-input rounded p-2 text-sm" />
                                    <input type="number" placeholder="kW" value={newLoc.kw} onChange={e => setNewLoc({ ...newLoc, kw: Number(e.target.value) })} className="glass-input rounded p-2 text-sm" />
                                </div>
                                <button onClick={handleSaveLocation} className="w-full py-2 bg-cyber-dark text-cyber-primary border border-cyber-primary rounded hover:bg-cyber-primary hover:text-black transition-colors text-sm font-bold uppercase mb-1">
                                    {editingLocId ? 'Update Location' : 'Add Location'}
                                </button>
                                {editingLocId && (
                                    <button onClick={cancelEdit} className="w-full py-1 text-xs text-cyber-dim hover:text-white underline">
                                        Cancel Edit
                                    </button>
                                )}
                            </div>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm text-cyber-dim mb-2">Google Apps Script URL</label>
                            <input
                                type="text"
                                value={gasUrl}
                                onChange={(e) => setGasUrl(e.target.value)}
                                placeholder="https://script.google.com/..."
                                className="w-full bg-cyber-black/50 border border-cyber-glassBorder rounded p-3 text-white focus:border-cyber-primary focus:outline-none"
                            />
                        </div>

                        <div className="flex justify-end">
                            <button onClick={onClose} className="bg-cyber-primary text-black font-bold py-2 px-6 rounded hover:bg-white transition-colors">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryList = ({ isOpen, onClose, history, onDelete, onEdit, onDeleteAll, onDeleteMany }) => {
            const [selectedIds, setSelectedIds] = useState([]);

            // Reset selection when closing or history changes
            useEffect(() => {
                if (!isOpen) setSelectedIds([]);
                lucide.createIcons();
            }, [isOpen, history]);

            useEffect(() => {
                lucide.createIcons();
            });

            const toggleSelect = (id) => {
                setSelectedIds(prev =>
                    prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]
                );
            };

            const handleSelectAll = () => {
                if (selectedIds.length === history.length) {
                    setSelectedIds([]);
                } else {
                    setSelectedIds(history.map(h => h.id));
                }
            };

            const executeDeleteSelected = () => {
                if (selectedIds.length > 0) {
                    onDeleteMany(selectedIds);
                    setSelectedIds([]);
                }
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/80 backdrop-blur-sm transition-all">
                    <div className="glass-panel w-full sm:max-w-md h-[85vh] sm:h-auto sm:max-h-[85vh] rounded-t-2xl sm:rounded-2xl p-6 relative flex flex-col animate-slide-up">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-display text-cyber-primary flex items-center gap-2">
                                <Icon name="history" /> History
                            </h2>
                            <div className="flex gap-2">
                                {selectedIds.length > 0 ? (
                                    <button onClick={executeDeleteSelected} className="text-xs text-cyber-accent border border-cyber-accent px-2 py-1 rounded hover:bg-cyber-accent/10 flex items-center gap-1">
                                        <Icon name="trash-2" size={12} /> Delete ({selectedIds.length})
                                    </button>
                                ) : (
                                    history.length > 0 && (
                                        <button onClick={onDeleteAll} className="text-xs text-cyber-dim border border-cyber-dim px-2 py-1 rounded hover:bg-white/10">
                                            Delete All
                                        </button>
                                    )
                                )}
                                <button onClick={onClose} className="text-cyber-dim hover:text-white">
                                    <Icon name="x" />
                                </button>
                            </div>
                        </div>

                        {history.length > 0 && (
                            <div className="flex items-center gap-2 mb-2 px-1">
                                <input
                                    type="checkbox"
                                    checked={history.length > 0 && selectedIds.length === history.length}
                                    onChange={handleSelectAll}
                                    className="w-4 h-4 rounded border-cyber-dim bg-transparent accent-cyber-primary cursor-pointer"
                                />
                                <span className="text-xs text-cyber-dim">Select All</span>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto cyber-scroll pr-2 space-y-3 pb-4">
                            {history.length === 0 ? (
                                <div className="text-center text-cyber-dim py-10">No records found.</div>
                            ) : (
                                history.map(item => (
                                    <div key={item.id} className={`bg-white/5 rounded-lg p-3 border-l-2 transition-colors ${selectedIds.includes(item.id) ? 'border-cyber-primary bg-cyber-primary/10' : 'border-cyber-dim'}`}>
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex items-start gap-3">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedIds.includes(item.id)}
                                                    onChange={() => toggleSelect(item.id)}
                                                    className="mt-1 w-4 h-4 rounded border-cyber-dim bg-transparent accent-cyber-primary cursor-pointer"
                                                />
                                                <div>
                                                    <div className="text-xs text-cyber-dim">{item.startTime ? formatDate(item.startTime) : formatDate(item.timestamp)}</div>
                                                    <div className="flex items-baseline gap-2 mt-1">
                                                        <span className="text-lg font-display text-white">{item.startRange || '-'} <Icon name="arrow-right" size={12} className="inline" /> {item.endRange || '-'}</span>
                                                        <span className="text-xs text-cyber-dim">km</span>
                                                    </div>
                                                    <div className="text-sm font-tech text-white mt-1">
                                                        Batt: {item.battery || item.startBattery}% <Icon name="arrow-right" size={12} className="inline" /> {item.batteryAfter || item.endBattery}%
                                                    </div>
                                                    {item.locationName && (
                                                        <div className="text-xs text-cyber-primary mt-1 flex items-center gap-1">
                                                            <Icon name="map-pin" size={10} /> {item.locationName}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => onEdit(item)} className="h-10 w-10 flex items-center justify-center bg-cyber-primary text-black rounded font-bold hover:bg-white transition-colors shadow-[0_0_10px_rgba(0,240,255,0.3)]">
                                                    <Icon name="edit-2" size={18} />
                                                </button>
                                                <button onClick={() => onDelete(item.id)} className="h-10 w-10 flex items-center justify-center bg-cyber-dark border border-cyber-accent text-cyber-accent rounded hover:bg-cyber-accent hover:text-white transition-colors">
                                                    <Icon name="trash-2" size={18} />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        <button onClick={onClose} className="w-full py-3 mt-4 bg-cyber-dark border border-cyber-dim text-cyber-dim font-bold rounded-xl uppercase tracking-widest hover:text-white hover:border-white transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            );
        };

        const EditSessionModal = ({ isOpen, onClose, item, onSave }) => {
            if (!isOpen || !item) return null;

            const [formData, setFormData] = useState({ ...item });

            useEffect(() => {
                setFormData({ ...item });
                setTimeout(() => lucide.createIcons(), 0);
            }, [item]);

            const handleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handleSave = () => {
                onSave(formData);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div className="glass-panel w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl p-6 relative cyber-scroll">
                        <button onClick={onClose} className="absolute top-4 right-4 text-cyber-dim hover:text-white">
                            <Icon name="x" />
                        </button>
                        <h2 className="text-xl font-display text-cyber-primary mb-6 flex items-center gap-2">
                            <Icon name="edit-2" /> Edit Session
                        </h2>

                        <div className="space-y-4">
                            {/* Date Inputs - Stacked */}
                            <div className="mb-3">
                                <label className="text-cyber-dim text-xs font-tech uppercase mb-1 block">Start</label>
                                <input type="datetime-local" value={formData.startTime || formData.timestamp || ''} onChange={(e) => handleChange('startTime', e.target.value)} className="glass-input rounded p-2 text-sm w-full" />
                            </div>
                            <div className="mb-3">
                                <label className="text-cyber-dim text-xs font-tech uppercase mb-1 block">End</label>
                                <input type="datetime-local" value={formData.endTime || ''} onChange={(e) => handleChange('endTime', e.target.value)} className="glass-input rounded p-2 text-sm w-full" />
                            </div>

                            {/* Odometer - Compact */}
                            <div className="mb-3">
                                <label className="text-cyber-dim text-xs font-tech uppercase mb-1 block">Odometer (km)</label>
                                <div className="flex items-center gap-1 glass-input rounded p-2">
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) - 100)} className="cyber-btn h-8 w-12 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-accent text-xs font-bold">-100</button>
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) - 10)} className="cyber-btn h-8 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-accent text-xs font-bold">-10</button>
                                    <input type="number" value={Number(formData.odometer || 0)} onChange={(e) => handleChange('odometer', Number(e.target.value))} className="flex-1 bg-transparent text-center text-lg font-display text-cyber-primary focus:outline-none" />
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) + 10)} className="cyber-btn h-8 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-primary text-xs font-bold">+10</button>
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) + 100)} className="cyber-btn h-8 w-12 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-primary text-xs font-bold">+100</button>
                                </div>
                            </div>

                            <SmartNumberInput label="Efficiency" value={Number(formData.efficiency)} unit="km/kWh" steps={[-1, -0.1, 0.1, 1]} min={0} max={20} onChange={(v) => handleChange('efficiency', v)} />

                            <div className="p-3 border border-cyber-glassBorder rounded-lg bg-white/5">
                                <div className="text-xs text-cyber-dim mb-2 uppercase tracking-widest">Start Conditions</div>
                                <SmartNumberInput label="Batt %" value={Number(formData.startBattery || formData.battery || 0)} unit="%" onChange={(v) => handleChange('startBattery', v)} />
                                <SmartNumberInput label="Range" value={Number(formData.startRange || 0)} unit="km" onChange={(v) => handleChange('startRange', v)} />
                            </div>

                            <div className="p-3 border border-cyber-glassBorder rounded-lg bg-white/5">
                                <div className="text-xs text-cyber-dim mb-2 uppercase tracking-widest">End Conditions</div>
                                <SmartNumberInput label="Batt %" value={Number(formData.endBattery || formData.batteryAfter || 0)} unit="%" onChange={(v) => handleChange('endBattery', v)} />
                                <SmartNumberInput label="Range" value={Number(formData.endRange || 0)} unit="km" onChange={(v) => handleChange('endRange', v)} />
                            </div>

                            <div className="flex gap-2 mt-4">
                                <button onClick={onClose} className="flex-1 py-3 bg-cyber-dark border border-cyber-dim text-cyber-dim font-bold rounded-xl uppercase tracking-widest hover:text-white hover:border-white transition-colors">
                                    Cancel
                                </button>
                                <button onClick={handleSave} className="flex-[2] py-3 bg-cyber-primary text-black font-bold rounded-xl uppercase tracking-widest hover:bg-white transition-colors">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            // State
            const [engine, setEngine] = useState(null);
            const [chargingSession, setChargingSession] = useState(null); // Objects if active session exists

            // Common inputs
            const [odometer, setOdometer] = useState(10000);
            const [efficiency, setEfficiency] = useState(6.0);

            // Start Phase Inputs
            const [startTime, setStartTime] = useState(getLocalISOString());
            const [startBattery, setStartBattery] = useState(50);
            const [startRange, setStartRange] = useState(200);

            // End Phase Inputs
            const [endTime, setEndTime] = useState(getLocalISOString());
            const [endBattery, setEndBattery] = useState(80);
            const [endRange, setEndRange] = useState(350);

            const [locations, setLocations] = useState([]);
            const [selectedLocationId, setSelectedLocationId] = useState("");

            const [history, setHistory] = useState([]);
            const [gasUrl, setGasUrl] = useState(PRE_CONFIGURED_GAS_URL);

            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            // Load Data & Session
            useEffect(() => {
                const savedData = localStorage.getItem(STORAGE_KEY_DATA);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    setHistory(parsed);
                }
                const savedSettings = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    setGasUrl(parsed.gasUrl || PRE_CONFIGURED_GAS_URL);
                }
                const savedLocations = localStorage.getItem(STORAGE_KEY_LOCATIONS);
                if (savedLocations) {
                    setLocations(JSON.parse(savedLocations));
                }

                const savedSession = localStorage.getItem(STORAGE_KEY_SESSION);
                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    setChargingSession(session);
                    // Hydrate End Form defaults based on session
                    setEndBattery(Math.min(session.startBattery + 20, 100)); // Guess +20%
                    setEndRange(session.startRange + 50); // Guess +50km
                    setEndTime(getLocalISOString()); // Current time
                } else {
                    // If no session, try to inherit Odometer from history
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        if (parsed.length > 0) setOdometer(parsed[0].odometer);
                    }
                }

                lucide.createIcons();
            }, []);

            // Save Locations
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_LOCATIONS, JSON.stringify(locations));
            }, [locations]);

            // Physics Spawner
            const spawnDataBlock = (data) => {
                if (!engine) return;
                const width = 60;
                const height = 60;
                const x = Math.random() * (window.innerWidth - 100) + 50;
                const y = -100;
                const body = Bodies.rectangle(x, y, width, height, {
                    restitution: 0.8,
                    friction: 0.005,
                    density: 0.04,
                    chamfer: { radius: 10 },
                    render: {
                        fillStyle: getRandomColor(),
                        strokeStyle: '#ffffff',
                        lineWidth: 2,
                        opacity: 0.9
                    }
                });
                Body.setVelocity(body, { x: (Math.random() - 0.5) * 5, y: 5 });
                Body.setAngularVelocity(body, (Math.random() - 0.5) * 0.2);
                World.add(engine.world, body);
            };

            // Initial Physics Population
            const hasSpawnedRef = useRef(false);
            useEffect(() => {
                if (engine && history.length > 0 && !hasSpawnedRef.current) {
                    hasSpawnedRef.current = true;
                    history.slice(0, 5).forEach((item, i) => {
                        setTimeout(() => spawnDataBlock(item), i * 200);
                    });
                }
            }, [engine, history]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify({ gasUrl }));
            }, [gasUrl]);

            // --- Handlers ---

            // Phase 1: Start Charging
            const handleStartCharging = () => {
                const loc = locations.find(l => l.id === selectedLocationId) || {};
                const session = {
                    id: generateId(),
                    startTime,
                    odometer, // Locked at start
                    startBattery,
                    startRange,
                    efficiency,
                    startedAt: Date.now(), // For failsafes
                    locationName: loc.name || "",
                    voltage: loc.voltage || "",
                    amperage: loc.amperage || "",
                    kw: loc.kw || ""
                };
                setChargingSession(session);
                localStorage.setItem(STORAGE_KEY_SESSION, JSON.stringify(session));

                // Set defaults for End phase for convenience
                setEndBattery(100);
                setEndRange(100);
                setEndTime(getLocalISOString());
            };

            // Phase 2: Complete Charging
            const handleCompleteCharging = async () => {
                setIsSaving(true);

                const finalRecord = {
                    ...chargingSession,
                    endTime,
                    endBattery,
                    endRange
                };

                // Save to History
                const newHistory = [finalRecord, ...history];
                setHistory(newHistory);
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));

                // Clear Session
                setChargingSession(null);
                localStorage.removeItem(STORAGE_KEY_SESSION);

                // Initialize next start defaults
                setStartBattery(endBattery);
                setStartRange(endRange);
                setOdometer(finalRecord.odometer); // Odometer shouldn't change during charging, so it stays same
                setStartTime(getLocalISOString()); // Reset start time to now

                // Physics Reward
                spawnDataBlock(finalRecord);

                // Send to GAS
                if (gasUrl) {
                    try {
                        const payload = {
                            startTime: finalRecord.startTime || "",
                            endTime: finalRecord.endTime || "",
                            odometer: String(finalRecord.odometer || ""),
                            efficiency: String(finalRecord.efficiency || ""),
                            startBattery: String(finalRecord.startBattery || ""),
                            endBattery: String(finalRecord.endBattery || ""),
                            startRange: String(finalRecord.startRange || ""),
                            endRange: String(finalRecord.endRange || ""),
                            locationName: String(finalRecord.locationName || ""),
                            voltage: String(finalRecord.voltage || ""),
                            amperage: String(finalRecord.amperage || ""),
                            kw: String(finalRecord.kw || "")
                        };

                        // Fallback to simpler JSON if needed, but trying no-cors with JSON
                        await fetch(gasUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        console.log("Sent formatted data to GAS", payload);
                    } catch (e) {
                        console.error("GAS Error", e);
                    }
                }
                setTimeout(() => setIsSaving(false), 500);
            };

            const handleDelete = (id) => {
                if (confirm("Are you sure you want to delete this record?")) {
                    const newHistory = history.filter(item => item.id !== id);
                    setHistory(newHistory);
                    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));
                }
            };

            const handleDeleteAll = () => {
                if (confirm("DANGER: Delete ALL history records? This cannot be undone.")) {
                    setHistory([]);
                    localStorage.removeItem(STORAGE_KEY_DATA);
                }
            };

            const handleDeleteMany = (ids) => {
                if (confirm(`Delete ${ids.length} selected records?`)) {
                    const newHistory = history.filter(item => !ids.includes(item.id));
                    setHistory(newHistory);
                    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));
                }
            };

            const handleUpdateSession = (updatedItem) => {
                const newHistory = history.map(item => item.id === updatedItem.id ? updatedItem : item);
                setHistory(newHistory);
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));
                setEditingItem(null);
            };

            const handleCancelSession = () => {
                if (confirm("Cancel current charging session?")) {
                    setChargingSession(null);
                    localStorage.removeItem(STORAGE_KEY_SESSION);
                }
            };

            return (
                <>
                    <PhysicsBackground onEngineReady={setEngine} />

                    <div className="relative z-10 w-full h-screen flex flex-col pointer-events-none">

                        {/* Header */}
                        <header className="p-3 flex justify-between items-center pointer-events-auto">
                            <h1 className="text-2xl font-display text-white italic tracking-tighter drop-shadow-lg">
                                EV<span className="text-cyber-primary">GRAVITY</span>
                            </h1>
                            <div className="flex gap-2">
                                <button onClick={() => setShowHistory(true)} className="glass-panel p-2 rounded-full text-cyber-primary hover:bg-white/10 transition">
                                    <Icon name="history" />
                                </button>
                                <button onClick={() => setShowSettings(true)} className="glass-panel p-2 rounded-full text-cyber-primary hover:bg-white/10 transition">
                                    <Icon name="settings" />
                                </button>
                            </div>
                        </header>

                        <div className="flex-1"></div>

                        {/* Main Form Area - Scrollable */}
                        <main className="p-2 w-full max-w-md mx-auto pointer-events-auto overflow-y-auto pb-6" style={{ maxHeight: 'calc(100dvh - 100px)' }}>
                            <div className="glass-panel rounded-2xl p-4 border-t border-cyber-glassBorder backdrop-blur-xl bg-black/40 shadow-2xl animate-fade-in-up">

                                {/* CASE 1: IDLE (Start Charging) */}
                                {!chargingSession && (
                                    <>
                                        <div className="flex items-center gap-2 mb-2 text-cyber-primary">
                                            <Icon name="plug-zap" />
                                            <h2 className="text-lg font-display">START CHARGING</h2>
                                        </div>

                                        <DateTimeInput
                                            label="Start Time"
                                            value={startTime}
                                            onChange={setStartTime}
                                        />

                                        <Odometer value={odometer} onChange={setOdometer} />

                                        <div className="flex flex-col gap-2">
                                            <SmartNumberInput
                                                label="Battery (%)"
                                                value={startBattery}
                                                unit="%"
                                                min={0} max={100}
                                                onChange={setStartBattery}
                                            />
                                            <SmartNumberInput
                                                label="Range (km)"
                                                value={startRange}
                                                unit="km"
                                                steps={[-10, -1, 1, 10]}
                                                min={0} max={1000}
                                                onChange={setStartRange}
                                            />
                                        </div>

                                        <SmartNumberInput
                                            label="Efficiency (km/kWh)"
                                            value={efficiency}
                                            unit=""
                                            steps={[-1, -0.1, 0.1, 1]}
                                            min={0} max={20}
                                            onChange={setEfficiency}
                                        />

                                        {/* Location Selector */}
                                        <div className="mb-2">
                                            <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1 font-bold flex items-center gap-2">
                                                <Icon name="map-pin" size={12} /> Charging Location
                                            </label>
                                            <div className="relative">
                                                <select
                                                    value={selectedLocationId}
                                                    onChange={(e) => setSelectedLocationId(e.target.value)}
                                                    className="w-full glass-input rounded-lg p-3 text-cyber-primary appearance-none focus:outline-none bg-black/50"
                                                >
                                                    <option value="">-- Manual / Unspecified --</option>
                                                    {locations.map(loc => (
                                                        <option key={loc.id} value={loc.id}>{loc.name} ({loc.kw}kW)</option>
                                                    ))}
                                                </select>
                                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-cyber-primary">
                                                    <Icon name="chevron-down" size={16} />
                                                </div>
                                            </div>
                                        </div>

                                        <button
                                            onClick={handleStartCharging}
                                            className="w-full mt-4 py-4 rounded-xl font-display font-bold text-xl tracking-widest uppercase bg-gradient-to-r from-cyber-secondary to-cyber-accent text-white shadow-lg hover:shadow-cyber-accent/50 transition-all transform active:scale-95"
                                        >
                                            START CHARGING
                                        </button>
                                    </>
                                )}

                                {/* CASE 2: ACTIVE (Finish Charging) */}
                                {chargingSession && (
                                    <>
                                        <div className="flex justify-between items-start mb-6">
                                            <div className="flex items-center gap-2 text-cyber-accent animate-pulse">
                                                <Icon name="battery-charging" />
                                                <h2 className="text-lg font-display">CHARGING IN PROGRESS...</h2>
                                            </div>
                                            <button onClick={handleCancelSession} className="text-xs text-cyber-dim underline hover:text-white">Cancel</button>
                                        </div>

                                        <div className="bg-white/5 rounded-lg p-3 mb-6 border border-cyber-glassBorder">
                                            <div className="text-xs text-cyber-dim uppercase">Started At</div>
                                            <div className="text-white font-mono">{formatDate(chargingSession.startTime)}</div>
                                            <div className="flex justify-between mt-2">
                                                <div>
                                                    <div className="text-xs text-cyber-dim">Batt</div>
                                                    <div className="text-cyber-primary font-display">{chargingSession.startBattery}%</div>
                                                </div>
                                                <div>
                                                    <div className="text-xs text-cyber-dim">Range</div>
                                                    <div className="text-cyber-primary font-display">{chargingSession.startRange}km</div>
                                                </div>
                                                <div>
                                                    <div className="text-xs text-cyber-dim">Odo</div>
                                                    <div className="text-cyber-primary font-display">{chargingSession.odometer}km</div>
                                                </div>
                                            </div>
                                        </div>

                                        <DateTimeInput
                                            label="End Time"
                                            value={endTime}
                                            onChange={setEndTime}
                                        />

                                        <div className="flex flex-col gap-2">
                                            <SmartNumberInput
                                                label="Battery (End)"
                                                value={endBattery}
                                                unit="%"
                                                min={0} max={100}
                                                onChange={setEndBattery}
                                            />
                                            <SmartNumberInput
                                                label="Range (End)"
                                                value={endRange}
                                                unit="km"
                                                steps={[-10, -1, 1, 10]}
                                                min={0} max={1000}
                                                onChange={setEndRange}
                                            />
                                        </div>

                                        <button
                                            onClick={handleCompleteCharging}
                                            disabled={isSaving}
                                            className={`w-full mt-4 py-4 rounded-xl font-display font-bold text-xl tracking-widest uppercase transition-all transform active:scale-95
                                                ${isSaving
                                                    ? 'bg-cyber-primary text-black shadow-[0_0_30px_#00f0ff]'
                                                    : 'bg-cyber-primary text-black shadow-lg hover:shadow-cyber-primary/50'
                                                }
                                            `}
                                        >
                                            {isSaving ? 'SAVING...' : 'COMPLETE & SAVE'}
                                        </button>
                                    </>
                                )}

                            </div>
                        </main>
                    </div>

                    {/* Modals */}
                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        gasUrl={gasUrl}
                        setGasUrl={setGasUrl}
                        locations={locations}
                        setLocations={setLocations}
                    />

                    <HistoryList
                        isOpen={showHistory}
                        onClose={() => setShowHistory(false)}
                        history={history}
                        onDelete={handleDelete}
                        onDeleteAll={handleDeleteAll}
                        onDeleteMany={handleDeleteMany}
                        onEdit={setEditingItem}
                    />

                    <EditSessionModal
                        isOpen={!!editingItem}
                        onClose={() => setEditingItem(null)}
                        item={editingItem}
                        onSave={handleUpdateSession}
                    />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Lucide icons re-init for dynamic content if needed, mostly handled in component
    </script>
</body>

</html>