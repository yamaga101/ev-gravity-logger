<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EV Gravity Logger</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f0ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#0a0a0f',
                            dark: '#13131f',
                            primary: '#00f0ff',
                            secondary: '#7000df',
                            accent: '#ff003c',
                            glass: 'rgba(255, 255, 255, 0.05)',
                            glassBorder: 'rgba(255, 255, 255, 0.1)',
                            text: '#e0e0e0',
                            dim: '#8888aa',
                            success: '#00ff88',
                        }
                    },
                    fontFamily: {
                        display: ['Orbitron', 'sans-serif'],
                        tech: ['Rajdhani', 'sans-serif'],
                        body: ['Noto Sans JP', 'sans-serif'],
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #0a0a0f;
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .cyber-scroll::-webkit-scrollbar { width: 4px; }
        .cyber-scroll::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        .cyber-scroll::-webkit-scrollbar-thumb { background: #00f0ff; border-radius: 2px; }

        .glass-panel {
            background: rgba(19, 19, 31, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 240, 255, 0.2);
            color: #00f0ff;
            font-family: 'Rajdhani', sans-serif;
            transition: all 0.2s;
        }

        .glass-input:focus {
            border-color: #00f0ff;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
            outline: none;
        }

        .text-neon {
            text-shadow: 0 0 5px rgba(0, 240, 255, 0.7), 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .text-neon-pink {
            text-shadow: 0 0 5px rgba(255, 0, 60, 0.7), 0 0 10px rgba(255, 0, 60, 0.5);
        }

        .odometer-digit {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .cyber-btn:active { transform: scale(0.95); }
        .no-select { user-select: none; -webkit-user-select: none; }
        .h-dvh { height: 100vh; height: 100dvh; }

        /* Toast Animations */
        @keyframes toast-in {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100px); opacity: 0; }
        }
        .toast-enter { animation: toast-in 0.3s ease-out forwards; }
        .toast-exit { animation: toast-out 0.3s ease-in forwards; }

        /* Shake Animation for validation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        /* Validation error border */
        .input-error { border-color: #ff003c !important; box-shadow: 0 0 10px rgba(255,0,60,0.3) !important; }

        /* Pulse glow for live charging */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0,240,255,0.2); }
            50% { box-shadow: 0 0 40px rgba(0,240,255,0.5), 0 0 60px rgba(0,240,255,0.2); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }

        /* Progress ring animation */
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Particle burst */
        @keyframes particle-burst {
            0% { transform: translate(0,0) scale(1); opacity: 1; }
            100% { transform: translate(var(--px), var(--py)) scale(0); opacity: 0; }
        }
        .particle {
            position: absolute;
            width: 6px; height: 6px;
            border-radius: 50%;
            animation: particle-burst 1s ease-out forwards;
        }

        /* Onboarding slide */
        @keyframes slide-in-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in { animation: slide-in-right 0.3s ease-out forwards; }

        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Constants & Config ---
        const PRE_CONFIGURED_GAS_URL = "https://script.google.com/macros/s/AKfycby6A4grTpYFeWSNAcmWwtqYqG7fVEThhYhXZz6qj4i-C4knWEVY3Ka8TOSnoUPpUUu4/exec";
        const STORAGE_KEY_DATA = "ev_gravity_data_v1";
        const STORAGE_KEY_SETTINGS = "ev_gravity_settings_v1";
        const STORAGE_KEY_SESSION = "ev_gravity_session_v1";
        const STORAGE_KEY_LOCATIONS = "ev_gravity_locations_v1";
        const STORAGE_KEY_QUEUE = "ev_gravity_queue_v1";
        const STORAGE_KEY_ONBOARDING = "ev_gravity_onboarding_done";
        const STORAGE_KEY_LANG = "ev_gravity_lang";

        // --- Language Dictionary ---
        const LANG = {
            en: {
                startCharging: 'START CHARGING',
                charging: 'CHARGING...',
                completeAndSave: 'COMPLETE & SAVE',
                saving: 'SAVING...',
                chargeComplete: 'CHARGE COMPLETE',
                startTime: 'Start Time',
                endTime: 'End Time',
                odometer: 'Odometer (km)',
                batteryPct: 'Battery (%)',
                rangeKm: 'Range (km)',
                efficiency: 'Efficiency (km/kWh)',
                chargingLocation: 'Charging Location',
                manualUnspecified: '-- Manual / Unspecified --',
                elapsed: 'elapsed',
                estPct: 'Est. %',
                cost: 'Cost',
                estDone: 'Est. Done',
                duration: 'Duration',
                cancel: 'Cancel',
                delete: 'Delete',
                close: 'Close',
                settings: 'Settings',
                vehicle: 'Vehicle',
                batteryCapacity: 'Battery Capacity (kWh)',
                electricityRate: 'Electricity Rate (JPY/kWh)',
                nightRate: 'Night Rate',
                chargingLocations: 'Charging Locations',
                addNewLocation: 'Add New Location',
                editLocation: 'Edit Location',
                addLocation: 'Add Location',
                updateLocation: 'Update Location',
                cancelEdit: 'Cancel Edit',
                noLocations: 'No locations added.',
                gasUrl: 'Google Apps Script URL',
                offlineQueue: 'Offline Queue',
                pendingItems: 'pending',
                autoSendOnline: 'These will auto-send when online.',
                done: 'Done',
                history: 'History',
                csv: 'CSV',
                deleteAll: 'Delete All',
                selectAll: 'Select All',
                allLocations: 'All Locations',
                noRecords: 'No records found.',
                editSession: 'Edit Session',
                startConditions: 'Start Conditions',
                endConditions: 'End Conditions',
                saveChanges: 'Save Changes',
                statistics: 'Statistics',
                totalSessions: 'Total Sessions',
                totalKwh: 'Total kWh',
                totalCost: 'Total Cost',
                avgEfficiency: 'Avg km/kWh',
                monthlyCharges: 'Monthly Charges',
                efficiencyTrend: 'Efficiency Trend (km/kWh)',
                byLocation: 'By Location',
                noDataPeriod: 'No data for this period.',
                newVersionAvail: 'New version available',
                update: 'UPDATE',
                later: 'Later',
                battEnd: 'Battery (End)',
                rangeEnd: 'Range (End)',
                battPct: 'Batt %',
                range: 'Range',
                start: 'Start',
                end: 'End',
                next: 'NEXT',
                back: 'Back',
                vehicleSettings: 'Vehicle Settings',
                azHint: 'AZE0 Leaf = 30kWh',
                gSheetLink: 'Google Sheets Link',
                gSheetDesc: 'Set GAS URL to auto-send charging data to spreadsheet.',
                gSheetHint: 'You can change this later in Settings. Skip OK.',
                welcomeSub1: 'Record & analyze EV charging sessions',
                welcomeSub2: 'Fun charging management with cyberpunk UI',
                feat1: '2-phase charge logging',
                feat2: 'Statistics dashboard',
                feat3: 'CSV export',
                feat4: 'Google Sheets sync',
                confirmDelete: 'Are you sure you want to delete this record?',
                confirmDeleteAll: 'DANGER: Delete ALL history records? This cannot be undone.',
                confirmDeleteN: 'Delete {n} selected records?',
                confirmCancelSession: 'Cancel current charging session?',
                toastCsvExported: 'CSV exported successfully',
                toastSavedSent: 'Data saved & sent to Google Sheets',
                toastSavedQueued: 'Saved locally. Queued for sync when online.',
                toastSessionSaved: 'Charge session saved',
                toastWelcome: 'Welcome! Settings saved.',
                toastQueueSent: '{n} queued items sent',
                valEndBattery: 'End battery must be >= start battery',
                valEndRange: 'End range must be >= start range',
                valEndTime: 'End time must be after start time',
                valDuration: 'Charge duration exceeds {n}h',
            },
            ja: {
                startCharging: '充電開始',
                charging: '充電中...',
                completeAndSave: '完了して保存',
                saving: '保存中...',
                chargeComplete: '充電完了',
                startTime: '開始時刻',
                endTime: '終了時刻',
                odometer: '走行距離 (km)',
                batteryPct: 'バッテリー (%)',
                rangeKm: '航続距離 (km)',
                efficiency: '電費 (km/kWh)',
                chargingLocation: '充電場所',
                manualUnspecified: '-- 手動 / 未指定 --',
                elapsed: '経過',
                estPct: '推定 %',
                cost: 'コスト',
                estDone: '完了予定',
                duration: '所要時間',
                cancel: 'キャンセル',
                delete: '削除',
                close: '閉じる',
                settings: '設定',
                vehicle: '車両',
                batteryCapacity: 'バッテリー容量 (kWh)',
                electricityRate: '電力単価 (円/kWh)',
                nightRate: '深夜単価',
                chargingLocations: '充電場所一覧',
                addNewLocation: '新しい場所を追加',
                editLocation: '場所を編集',
                addLocation: '追加',
                updateLocation: '更新',
                cancelEdit: '編集キャンセル',
                noLocations: '場所が未登録です',
                gasUrl: 'Google Apps Script URL',
                offlineQueue: 'オフラインキュー',
                pendingItems: '件待機中',
                autoSendOnline: 'オンライン時に自動送信されます',
                done: '完了',
                history: '履歴',
                csv: 'CSV',
                deleteAll: '全て削除',
                selectAll: '全て選択',
                allLocations: '全場所',
                noRecords: '記録がありません',
                editSession: 'セッション編集',
                startConditions: '開始時',
                endConditions: '終了時',
                saveChanges: '変更を保存',
                statistics: '統計',
                totalSessions: '総充電回数',
                totalKwh: '総充電量',
                totalCost: '総コスト',
                avgEfficiency: '平均電費',
                monthlyCharges: '月別充電回数',
                efficiencyTrend: '電費推移 (km/kWh)',
                byLocation: '場所別',
                noDataPeriod: 'この期間のデータがありません',
                newVersionAvail: '新バージョンがあります',
                update: '更新',
                later: '後で',
                battEnd: 'バッテリー (終了)',
                rangeEnd: '航続距離 (終了)',
                battPct: 'バッテリー %',
                range: '航続距離',
                start: '開始',
                end: '終了',
                next: '次へ',
                back: '戻る',
                vehicleSettings: '車両設定',
                azHint: 'AZE0 リーフ = 30kWh',
                gSheetLink: 'Google Sheets 連携',
                gSheetDesc: 'GAS URLを設定すると充電データが自動送信されます',
                gSheetHint: '後から設定画面で変更できます。スキップ可',
                welcomeSub1: 'EV充電セッションを記録・分析',
                welcomeSub2: 'サイバーパンクUIで充電管理を楽しく',
                feat1: '2フェーズ充電記録',
                feat2: '統計ダッシュボード',
                feat3: 'CSVエクスポート',
                feat4: 'Google Sheets連携',
                confirmDelete: 'この記録を削除しますか？',
                confirmDeleteAll: '全ての履歴を削除しますか？元に戻せません。',
                confirmDeleteN: '選択した{n}件を削除しますか？',
                confirmCancelSession: '現在の充電セッションをキャンセルしますか？',
                toastCsvExported: 'CSVをエクスポートしました',
                toastSavedSent: '保存してGoogle Sheetsに送信しました',
                toastSavedQueued: 'ローカル保存済み。オンライン時に同期します',
                toastSessionSaved: '充電セッションを保存しました',
                toastWelcome: 'ようこそ！設定を保存しました',
                toastQueueSent: 'キュー{n}件を送信しました',
                valEndBattery: '終了バッテリーは開始以上にしてください',
                valEndRange: '終了航続距離は開始以上にしてください',
                valEndTime: '終了時刻は開始より後にしてください',
                valDuration: '充電時間が{n}時間を超えています',
            },
        };

        const CSV_HEADERS = {
            en: ['Date','Start Time','End Time','Odometer','Start %','End %','Start Range','End Range','Charged kWh','Cost (JPY)','Duration','Charge Speed (kW)','Efficiency','Location'],
            ja: ['日時','開始時刻','終了時刻','走行距離','開始%','終了%','開始航続','終了航続','充電量kWh','コスト(円)','所要時間','充電速度(kW)','電費','場所'],
        };

        // Vehicle defaults (AZE0 Leaf 30kWh)
        const DEFAULT_BATTERY_CAPACITY = 30;
        const DEFAULT_ELECTRICITY_RATE = 31;
        const DEFAULT_NIGHT_RATE = 17.78;
        const MAX_CHARGE_HOURS = 24;

        // --- Utils ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getTimestamp = () => new Date().toISOString();
        const getLocalISOString = (date = new Date()) => {
            const offset = date.getTimezoneOffset() * 60000;
            return (new Date(date - offset)).toISOString().slice(0, 16);
        };
        const formatDate = (isoString) => {
            const d = new Date(isoString);
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        };
        const getRandomColor = () => {
            const colors = ['#00f0ff', '#7000df', '#ff003c', '#e0e0e0', '#0a0a0f'];
            return colors[Math.floor(Math.random() * colors.length)];
        };

        // Charging calculations
        const calcChargedKwh = (capacity, startPct, endPct) => capacity * (endPct - startPct) / 100;
        const calcCost = (kwh, rate) => Math.round(kwh * rate);
        const calcDurationMinutes = (startIso, endIso) => {
            const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
            return Math.max(0, ms / 60000);
        };
        const calcChargeSpeed = (kwh, durationMin) => durationMin > 0 ? kwh / (durationMin / 60) : 0;
        const formatDuration = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = Math.floor(minutes % 60);
            return h > 0 ? `${h}h${m.toString().padStart(2, '0')}m` : `${m}m`;
        };
        const formatTimer = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };
        const getChargeSpeedBadge = (kw) => {
            if (kw > 20) return { emoji: '\u{1F534}', label: 'Rapid', color: '#ff003c' };
            if (kw >= 3) return { emoji: '\u{1F7E1}', label: 'Normal', color: '#ffaa00' };
            return { emoji: '\u{1F7E2}', label: 'Slow', color: '#00ff88' };
        };

        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { Engine, Render, Runner, World, Bodies, Body, Mouse, MouseConstraint, Composite, Events } = Matter;

        // --- Hooks ---
        const useRepeater = (callback, delay = 500, interval = 100) => {
            const timeoutIdRef = useRef(null);
            const intervalIdRef = useRef(null);
            const isRunningRef = useRef(false);
            const callbackRef = useRef(callback);

            useEffect(() => { callbackRef.current = callback; }, [callback]);

            const stop = useCallback(() => {
                isRunningRef.current = false;
                if (timeoutIdRef.current) { clearTimeout(timeoutIdRef.current); timeoutIdRef.current = null; }
                if (intervalIdRef.current) { clearInterval(intervalIdRef.current); intervalIdRef.current = null; }
            }, []);

            const start = useCallback(() => {
                if (isRunningRef.current) return;
                stop();
                isRunningRef.current = true;
                callbackRef.current();
                timeoutIdRef.current = setTimeout(() => {
                    if (!isRunningRef.current) return;
                    intervalIdRef.current = setInterval(() => {
                        if (isRunningRef.current) callbackRef.current(); else stop();
                    }, interval);
                }, delay);
            }, [delay, interval, stop]);

            useEffect(() => stop, [stop]);
            return { start, stop };
        };

        // --- Toast System ---
        let toastIdCounter = 0;
        const toastListeners = new Set();
        let toastState = [];

        const showToast = (message, type = 'info', duration = 3000) => {
            const id = ++toastIdCounter;
            const toast = { id, message, type, duration, exiting: false };
            toastState = [...toastState, toast];
            toastListeners.forEach(fn => fn(toastState));

            setTimeout(() => {
                toastState = toastState.map(t => t.id === id ? { ...t, exiting: true } : t);
                toastListeners.forEach(fn => fn(toastState));
                setTimeout(() => {
                    toastState = toastState.filter(t => t.id !== id);
                    toastListeners.forEach(fn => fn(toastState));
                }, 300);
            }, duration);
        };

        const useToasts = () => {
            const [toasts, setToasts] = useState(toastState);
            useEffect(() => {
                toastListeners.add(setToasts);
                return () => toastListeners.delete(setToasts);
            }, []);
            return toasts;
        };

        const ToastContainer = () => {
            const toasts = useToasts();
            const typeStyles = {
                success: 'border-l-4 border-[#00ff88] bg-[#00ff8815] text-[#00ff88]',
                error: 'border-l-4 border-[#ff003c] bg-[#ff003c15] text-[#ff003c]',
                info: 'border-l-4 border-[#00f0ff] bg-[#00f0ff15] text-[#00f0ff]',
            };
            return (
                <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-[90vw] max-w-sm pointer-events-none">
                    {toasts.map(t => (
                        <div key={t.id}
                            className={`glass-panel rounded-lg px-4 py-3 text-sm font-tech pointer-events-auto ${typeStyles[t.type] || typeStyles.info} ${t.exiting ? 'toast-exit' : 'toast-enter'}`}>
                            {t.message}
                        </div>
                    ))}
                </div>
            );
        };

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Components ---

        // 1. Physics World (Background)
        const PhysicsBackground = ({ onEngineReady }) => {
            const sceneRef = useRef(null);
            const engineRef = useRef(null);

            useEffect(() => {
                const engine = Engine.create();
                const world = engine.world;
                engineRef.current = engine;

                const render = Render.create({
                    element: sceneRef.current,
                    engine: engine,
                    options: {
                        width: window.innerWidth,
                        height: window.innerHeight,
                        background: 'transparent',
                        wireframes: false,
                        pixelRatio: window.devicePixelRatio
                    }
                });

                const updateWalls = () => {
                    Composite.clear(world, false, true);
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    const wallOptions = { isStatic: true, render: { fillStyle: '#13131f' } };
                    World.add(world, [
                        Bodies.rectangle(width / 2, height + 50, width, 100, wallOptions),
                        Bodies.rectangle(-50, height / 2, 100, height * 4, wallOptions),
                        Bodies.rectangle(width + 50, height / 2, 100, height * 4, wallOptions)
                    ]);
                };
                updateWalls();

                const mouse = Mouse.create(render.canvas);
                const mouseConstraint = MouseConstraint.create(engine, {
                    mouse: mouse,
                    constraint: { stiffness: 0.2, render: { visible: false } }
                });
                World.add(world, mouseConstraint);
                mouse.element.removeEventListener("mousewheel", mouse.mousewheel);
                mouse.element.removeEventListener("DOMMouseScroll", mouse.mousewheel);

                const runner = Runner.create();
                Runner.run(runner, engine);
                Render.run(render);

                if (onEngineReady) onEngineReady(engine);

                const handleResize = () => {
                    render.canvas.width = window.innerWidth;
                    render.canvas.height = window.innerHeight;
                    updateWalls();
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    Render.stop(render);
                    Runner.stop(runner);
                    if (render.canvas) render.canvas.remove();
                    window.removeEventListener('resize', handleResize);
                };
            }, []);

            return <div ref={sceneRef} className="fixed inset-0 z-0 pointer-events-auto" />;
        };

        // 2. Smart Input Components
        const RepeaterButton = ({ onClick, className, children }) => {
            const repeater = useRepeater(onClick);
            const hasStartedRef = useRef(false);
            const handlePointerDown = (e) => { e.preventDefault(); if (hasStartedRef.current) return; hasStartedRef.current = true; repeater.start(); };
            const handlePointerUp = (e) => { e.preventDefault(); hasStartedRef.current = false; repeater.stop(); };
            return (
                <button onPointerDown={handlePointerDown} onPointerUp={handlePointerUp}
                    onPointerCancel={handlePointerUp} onPointerLeave={handlePointerUp}
                    className={`${className} no-select`} type="button">
                    {children}
                </button>
            );
        };

        const SmartNumberInput = ({ label, value, unit, onChange, steps = [-10, -1, 1, 10], min = 0, max = 999999, error = false }) => {
            const adjust = (delta) => {
                let next = parseFloat((value + delta).toFixed(1));
                if (next < min) next = min;
                if (next > max) next = max;
                onChange(next);
            };
            const handleKeyDown = (e) => {
                if (e.key === 'ArrowUp' || e.key === 'ArrowRight') { e.preventDefault(); adjust(e.shiftKey ? steps[3] : steps[2]); }
                else if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') { e.preventDefault(); adjust(e.shiftKey ? steps[0] : steps[1]); }
            };
            return (
                <div className="flex flex-col gap-1 mb-2">
                    <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1">{label}</label>
                    <div className={`flex items-center justify-between glass-input rounded-lg p-1 focus-within:border-cyber-primary focus-within:shadow-[0_0_15px_rgba(0,240,255,0.2)] ${error ? 'input-error shake' : ''}`}
                        tabIndex="0" onKeyDown={handleKeyDown}>
                        <div className="flex gap-1">
                            {steps.filter(s => s < 0).map(step => (
                                <RepeaterButton key={step} onClick={() => adjust(step)}
                                    className="cyber-btn h-10 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-accent font-bold hover:bg-cyber-accent/20 transition-colors">
                                    {step}
                                </RepeaterButton>
                            ))}
                        </div>
                        <div className="flex items-baseline gap-1 flex-1 justify-center">
                            <input type="number" value={value} onChange={(e) => onChange(parseFloat(e.target.value))}
                                className="w-20 bg-transparent text-2xl font-display text-cyber-primary text-center focus:outline-none appearance-none p-0" />
                            <span className="text-xs text-cyber-dim font-tech">{unit}</span>
                        </div>
                        <div className="flex gap-1">
                            {steps.filter(s => s > 0).reverse().map(step => (
                                <RepeaterButton key={step} onClick={() => adjust(step)}
                                    className="cyber-btn h-10 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-primary font-bold hover:bg-cyber-primary/20 transition-colors">
                                    +{step}
                                </RepeaterButton>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const DateTimeInput = ({ label, value, onChange, error = false }) => {
            return (
                <div className="flex flex-col gap-1 mb-4">
                    <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1">{label}</label>
                    <input type="datetime-local" value={value} onChange={(e) => onChange(e.target.value)}
                        className={`glass-input w-full rounded-lg p-3 text-xl font-display text-center text-cyber-primary ${error ? 'input-error shake' : ''}`} />
                </div>
            );
        };

        const OdometerDigit = ({ value, onUp, onDown }) => {
            return (
                <div className="flex flex-col items-center gap-1">
                    <RepeaterButton onClick={onUp} className="cyber-btn p-1 text-cyber-primary hover:text-white transition-colors">
                        <Icon name="chevron-up" size={24} />
                    </RepeaterButton>
                    <div className="w-10 h-14 bg-black/80 border border-cyber-glassBorder rounded flex items-center justify-center overflow-hidden relative shadow-[inset_0_0_10px_rgba(0,0,0,0.8)]">
                        <div className="text-3xl font-display text-white z-10">{value}</div>
                        <div className="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/10 to-transparent pointer-events-none"></div>
                    </div>
                    <RepeaterButton onClick={onDown} className="cyber-btn p-1 text-cyber-primary hover:text-white transition-colors">
                        <Icon name="chevron-down" size={24} />
                    </RepeaterButton>
                </div>
            );
        };

        const Odometer = ({ value, onChange, t }) => {
            const digits = String(value).padStart(6, '0').split('').map(Number);
            const updateDigit = (index, delta) => {
                let newDigits = [...digits];
                let val = newDigits[index] + delta;
                if (val > 9) val = 0;
                if (val < 0) val = 9;
                newDigits[index] = val;
                onChange(parseInt(newDigits.join('')));
            };
            return (
                <div className="flex flex-col gap-1 mb-4">
                    <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1">{t.odometer}</label>
                    <div className="glass-panel rounded-xl p-3 flex justify-center gap-2 bg-gradient-to-b from-cyber-dark/80 to-cyber-black/80">
                        {digits.map((d, i) => (
                            <OdometerDigit key={i} value={d} onUp={() => updateDigit(i, 1)} onDown={() => updateDigit(i, -1)} />
                        ))}
                    </div>
                </div>
            );
        };

        // --- Onboarding Component ---
        const Onboarding = ({ onComplete, setVehicleSettings, t }) => {
            const [step, setStep] = useState(0);
            const [capacity, setCapacity] = useState(DEFAULT_BATTERY_CAPACITY);
            const [rate, setRate] = useState(DEFAULT_ELECTRICITY_RATE);
            const [nightRate, setNightRate] = useState(DEFAULT_NIGHT_RATE);
            const [useNightRate, setUseNightRate] = useState(false);
            const [gasUrl, setGasUrl] = useState(PRE_CONFIGURED_GAS_URL);

            useEffect(() => { lucide.createIcons(); });

            const steps = [
                // Step 0: Welcome
                <div key={0} className="slide-in text-center">
                    <div className="text-6xl mb-4">{'\u26A1'}</div>
                    <h2 className="text-3xl font-display text-cyber-primary text-neon mb-4">EV GRAVITY LOGGER</h2>
                    <p className="text-cyber-text text-lg mb-2">{t.welcomeSub1}</p>
                    <p className="text-cyber-dim text-sm">{t.welcomeSub2}</p>
                    <div className="mt-8 glass-panel rounded-lg p-4 text-left">
                        <div className="flex items-center gap-2 text-cyber-primary mb-2"><Icon name="battery-charging" size={16} /> {t.feat1}</div>
                        <div className="flex items-center gap-2 text-cyber-primary mb-2"><Icon name="bar-chart-3" size={16} /> {t.feat2}</div>
                        <div className="flex items-center gap-2 text-cyber-primary mb-2"><Icon name="download" size={16} /> {t.feat3}</div>
                        <div className="flex items-center gap-2 text-cyber-primary"><Icon name="cloud" size={16} /> {t.feat4}</div>
                    </div>
                </div>,
                // Step 1: Vehicle settings
                <div key={1} className="slide-in">
                    <h2 className="text-xl font-display text-cyber-primary mb-6 flex items-center gap-2">
                        <Icon name="car" /> {t.vehicleSettings}
                    </h2>
                    <div className="space-y-4">
                        <div>
                            <label className="text-cyber-dim text-xs font-tech uppercase block mb-1">{t.batteryCapacity}</label>
                            <input type="number" value={capacity} onChange={e => setCapacity(Number(e.target.value))}
                                className="w-full glass-input rounded-lg p-3 text-xl font-display text-center" />
                            <p className="text-xs text-cyber-dim mt-1">{t.azHint}</p>
                        </div>
                        <div>
                            <label className="text-cyber-dim text-xs font-tech uppercase block mb-1">{t.electricityRate}</label>
                            <input type="number" value={rate} onChange={e => setRate(Number(e.target.value))} step="0.01"
                                className="w-full glass-input rounded-lg p-3 text-xl font-display text-center" />
                        </div>
                        <div className="flex items-center gap-3 mt-2">
                            <input type="checkbox" checked={useNightRate} onChange={e => setUseNightRate(e.target.checked)}
                                className="w-5 h-5 accent-cyber-primary" />
                            <label className="text-cyber-dim text-sm">{t.nightRate}</label>
                            {useNightRate && (
                                <input type="number" value={nightRate} onChange={e => setNightRate(Number(e.target.value))} step="0.01"
                                    className="glass-input rounded p-2 text-sm w-24 ml-auto" />
                            )}
                        </div>
                    </div>
                </div>,
                // Step 2: GAS URL
                <div key={2} className="slide-in">
                    <h2 className="text-xl font-display text-cyber-primary mb-6 flex items-center gap-2">
                        <Icon name="cloud" /> {t.gSheetLink}
                    </h2>
                    <p className="text-cyber-dim text-sm mb-4">{t.gSheetDesc}</p>
                    <input type="text" value={gasUrl} onChange={e => setGasUrl(e.target.value)}
                        placeholder="https://script.google.com/..."
                        className="w-full glass-input rounded-lg p-3 text-sm mb-4" />
                    <p className="text-xs text-cyber-dim">{t.gSheetHint}</p>
                </div>
            ];

            const handleNext = () => {
                if (step < steps.length - 1) {
                    setStep(step + 1);
                } else {
                    // Save settings and complete
                    const vehicleSettings = {
                        batteryCapacity: capacity,
                        electricityRate: rate,
                        nightRate: nightRate,
                        useNightRate: useNightRate,
                        gasUrl: gasUrl
                    };
                    setVehicleSettings(vehicleSettings);
                    localStorage.setItem(STORAGE_KEY_ONBOARDING, 'true');
                    onComplete(vehicleSettings);
                }
            };

            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-cyber-black/95 backdrop-blur-lg">
                    <div className="w-full max-w-sm">
                        <div className="glass-panel rounded-2xl p-6 mb-4 min-h-[400px] flex flex-col justify-between">
                            <div className="flex-1">{steps[step]}</div>
                            <div className="mt-6">
                                <button onClick={handleNext}
                                    className="w-full py-4 rounded-xl font-display font-bold text-lg tracking-widest uppercase bg-gradient-to-r from-cyber-primary to-cyber-secondary text-black hover:shadow-lg transition-all">
                                    {step < steps.length - 1 ? t.next : t.startCharging}
                                </button>
                                {step > 0 && (
                                    <button onClick={() => setStep(step - 1)} className="w-full mt-2 py-2 text-cyber-dim text-sm hover:text-white">
                                        {t.back}
                                    </button>
                                )}
                            </div>
                        </div>
                        {/* Dot indicators */}
                        <div className="flex justify-center gap-2">
                            {steps.map((_, i) => (
                                <div key={i} className={`w-2 h-2 rounded-full transition-colors ${i === step ? 'bg-cyber-primary' : 'bg-cyber-dim/40'}`} />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Progress Ring SVG ---
        const ProgressRing = ({ radius = 70, stroke = 6, progress = 0 }) => {
            const normalizedRadius = radius - stroke;
            const circumference = normalizedRadius * 2 * Math.PI;
            const strokeDashoffset = circumference - (progress / 100) * circumference;

            return (
                <svg height={radius * 2} width={radius * 2} className="mx-auto">
                    <circle stroke="rgba(255,255,255,0.08)" fill="transparent" strokeWidth={stroke}
                        r={normalizedRadius} cx={radius} cy={radius} />
                    <circle className="progress-ring-circle" stroke="#00f0ff" fill="transparent"
                        strokeWidth={stroke} strokeLinecap="round"
                        strokeDasharray={`${circumference} ${circumference}`}
                        style={{ strokeDashoffset }} r={normalizedRadius} cx={radius} cy={radius} />
                </svg>
            );
        };

        // --- Live Charging Screen ---
        const LiveChargingScreen = ({ session, settings, endTime, setEndTime, endBattery, setEndBattery, endRange, setEndRange, onComplete, onCancel, isSaving, validationErrors, t }) => {
            const [elapsed, setElapsed] = useState(0);

            useEffect(() => {
                const startMs = new Date(session.startTime).getTime();
                const tick = () => setElapsed(Math.floor((Date.now() - startMs) / 1000));
                tick();
                const id = setInterval(tick, 1000);
                return () => clearInterval(id);
            }, [session.startTime]);

            useEffect(() => { lucide.createIcons(); });

            const locationKw = session.kw || 3;
            const capacity = settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY;
            const rate = settings.electricityRate || DEFAULT_ELECTRICITY_RATE;

            // Live estimates
            const remainPct = 100 - session.startBattery;
            const remainKwh = capacity * remainPct / 100;
            const estTotalMinutes = locationKw > 0 ? (remainKwh / locationKw) * 60 : 0;
            const estCompletionTime = new Date(new Date(session.startTime).getTime() + estTotalMinutes * 60000);
            const elapsedKwh = locationKw * (elapsed / 3600);
            const liveCost = Math.round(elapsedKwh * rate);
            const currentPct = Math.min(100, session.startBattery + (elapsedKwh / capacity) * 100);
            const progress = remainPct > 0 ? Math.min(100, ((currentPct - session.startBattery) / remainPct) * 100) : 100;

            return (
                <div className="pulse-glow glass-panel rounded-2xl p-4 border-t border-cyber-glassBorder backdrop-blur-xl bg-black/40 shadow-2xl">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-2 text-cyber-accent">
                            <Icon name="battery-charging" />
                            <h2 className="text-lg font-display animate-pulse">{t.charging}</h2>
                        </div>
                        <button onClick={onCancel} className="text-xs text-cyber-dim underline hover:text-white">{t.cancel}</button>
                    </div>

                    {/* Progress Ring + Timer */}
                    <div className="relative flex items-center justify-center mb-4">
                        <ProgressRing radius={70} stroke={6} progress={progress} />
                        <div className="absolute text-center">
                            <div className="text-3xl font-display text-cyber-primary text-neon">{formatTimer(elapsed)}</div>
                            <div className="text-xs text-cyber-dim">{t.elapsed}</div>
                        </div>
                    </div>

                    {/* Live Stats Row */}
                    <div className="grid grid-cols-3 gap-2 mb-4">
                        <div className="glass-panel rounded-lg p-2 text-center">
                            <div className="text-xs text-cyber-dim">{t.estPct}</div>
                            <div className="text-xl font-display text-cyber-primary">{Math.round(currentPct)}%</div>
                        </div>
                        <div className="glass-panel rounded-lg p-2 text-center">
                            <div className="text-xs text-cyber-dim">{t.cost}</div>
                            <div className="text-xl font-display text-cyber-success">&yen;{liveCost}</div>
                        </div>
                        <div className="glass-panel rounded-lg p-2 text-center">
                            <div className="text-xs text-cyber-dim">{t.estDone}</div>
                            <div className="text-sm font-display text-white">{estCompletionTime.getHours().toString().padStart(2,'0')}:{estCompletionTime.getMinutes().toString().padStart(2,'0')}</div>
                        </div>
                    </div>

                    {/* Session Info */}
                    <div className="bg-white/5 rounded-lg p-2 mb-4 text-xs">
                        <div className="flex justify-between text-cyber-dim">
                            <span>{t.start}: {formatDate(session.startTime)}</span>
                            <span>{session.startBattery}% / {session.startRange}km</span>
                        </div>
                        {session.locationName && (
                            <div className="text-cyber-primary mt-1 flex items-center gap-1">
                                <Icon name="map-pin" size={10} /> {session.locationName} ({locationKw}kW)
                            </div>
                        )}
                    </div>

                    {/* End Inputs (compact) */}
                    <div className="space-y-2">
                        <DateTimeInput label={t.endTime} value={endTime} onChange={setEndTime} error={validationErrors.endTime} />
                        <SmartNumberInput label={t.battEnd} value={endBattery} unit="%" min={0} max={100}
                            onChange={setEndBattery} error={validationErrors.endBattery} />
                        <SmartNumberInput label={t.rangeEnd} value={endRange} unit="km" steps={[-10, -1, 1, 10]}
                            min={0} max={1000} onChange={setEndRange} error={validationErrors.endRange} />
                    </div>

                    <button onClick={onComplete} disabled={isSaving}
                        className={`w-full mt-4 py-4 rounded-xl font-display font-bold text-xl tracking-widest uppercase transition-all transform active:scale-95
                            ${isSaving ? 'bg-cyber-primary text-black shadow-[0_0_30px_#00f0ff]' : 'bg-cyber-primary text-black shadow-lg hover:shadow-cyber-primary/50'}`}>
                        {isSaving ? <span><span className="spinner mr-2"></span>{t.saving}</span> : t.completeAndSave}
                    </button>
                </div>
            );
        };

        // --- Completion Summary Overlay ---
        const CompletionSummary = ({ record, settings, onDismiss, t }) => {
            const [particles, setParticles] = useState([]);
            useEffect(() => {
                lucide.createIcons();
                // Generate particles
                const ps = Array.from({ length: 24 }, (_, i) => ({
                    id: i,
                    x: `${(Math.random() - 0.5) * 200}px`,
                    y: `${(Math.random() - 0.5) * 200}px`,
                    color: getRandomColor(),
                    delay: `${Math.random() * 0.3}s`,
                }));
                setParticles(ps);
                const timer = setTimeout(onDismiss, 4000);
                return () => clearTimeout(timer);
            }, []);

            const capacity = settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY;
            const rate = settings.electricityRate || DEFAULT_ELECTRICITY_RATE;
            const kwh = calcChargedKwh(capacity, record.startBattery, record.endBattery);
            const cost = calcCost(kwh, rate);
            const duration = calcDurationMinutes(record.startTime, record.endTime);

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={onDismiss}>
                    <div className="relative">
                        {/* Particles */}
                        {particles.map(p => (
                            <div key={p.id} className="particle"
                                style={{ '--px': p.x, '--py': p.y, background: p.color, animationDelay: p.delay, left: '50%', top: '50%' }} />
                        ))}
                        <div className="glass-panel rounded-2xl p-6 text-center min-w-[280px] border border-cyber-primary/30">
                            <div className="text-4xl mb-2">{'\u26A1'}</div>
                            <h2 className="text-2xl font-display text-cyber-primary text-neon mb-4">{t.chargeComplete}</h2>
                            <div className="grid grid-cols-3 gap-3 mb-4">
                                <div>
                                    <div className="text-2xl font-display text-white">{kwh.toFixed(1)}</div>
                                    <div className="text-xs text-cyber-dim">kWh</div>
                                </div>
                                <div>
                                    <div className="text-2xl font-display text-cyber-success">&yen;{cost}</div>
                                    <div className="text-xs text-cyber-dim">{t.cost}</div>
                                </div>
                                <div>
                                    <div className="text-2xl font-display text-white">{formatDuration(duration)}</div>
                                    <div className="text-xs text-cyber-dim">{t.duration}</div>
                                </div>
                            </div>
                            <div className="text-sm text-cyber-dim">
                                {record.startBattery}% → {record.endBattery}%
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Stats Dashboard ---
        const StatsDashboard = ({ isOpen, onClose, history, settings, t }) => {
            const [period, setPeriod] = useState('ALL');
            const canvasBarRef = useRef(null);
            const canvasLineRef = useRef(null);
            const canvasLocRef = useRef(null);

            useEffect(() => { lucide.createIcons(); });

            const capacity = settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY;
            const rate = settings.electricityRate || DEFAULT_ELECTRICITY_RATE;

            const filteredHistory = useMemo(() => {
                if (period === 'ALL') return history;
                const months = { '1M': 1, '3M': 3, '6M': 6 }[period] || 999;
                const cutoff = new Date();
                cutoff.setMonth(cutoff.getMonth() - months);
                return history.filter(h => new Date(h.startTime || h.timestamp) >= cutoff);
            }, [history, period]);

            // Summary stats
            const stats = useMemo(() => {
                let totalKwh = 0, totalCost = 0, totalEffKm = 0, totalEffKwh = 0, effCount = 0;
                filteredHistory.forEach(h => {
                    const kwh = calcChargedKwh(capacity, h.startBattery || 0, h.endBattery || h.batteryAfter || 0);
                    const cost = calcCost(kwh, rate);
                    totalKwh += kwh;
                    totalCost += cost;
                    if (h.efficiency && h.efficiency > 0) {
                        totalEffKm += h.efficiency;
                        effCount++;
                    }
                });
                return {
                    count: filteredHistory.length,
                    totalKwh: totalKwh.toFixed(1),
                    totalCost: Math.round(totalCost),
                    avgEfficiency: effCount > 0 ? (totalEffKm / effCount).toFixed(1) : '-',
                };
            }, [filteredHistory, capacity, rate]);

            // Monthly bar chart
            useEffect(() => {
                const canvas = canvasBarRef.current;
                if (!canvas || filteredHistory.length === 0) return;
                const ctx = canvas.getContext('2d');
                const W = canvas.width = canvas.parentElement.clientWidth;
                const H = canvas.height = 160;
                ctx.clearRect(0, 0, W, H);

                // Group by month
                const monthMap = {};
                filteredHistory.forEach(h => {
                    const d = new Date(h.startTime || h.timestamp);
                    const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
                    monthMap[key] = (monthMap[key] || 0) + 1;
                });
                const entries = Object.entries(monthMap).sort((a,b) => a[0].localeCompare(b[0])).slice(-6);
                if (entries.length === 0) return;

                const maxVal = Math.max(...entries.map(e => e[1]), 1);
                const barW = Math.min(40, (W - 40) / entries.length - 8);
                const startX = (W - (barW + 8) * entries.length) / 2;

                entries.forEach(([label, val], i) => {
                    const x = startX + i * (barW + 8);
                    const barH = (val / maxVal) * (H - 40);
                    const y = H - 25 - barH;

                    // Bar gradient
                    const grad = ctx.createLinearGradient(x, y, x, H - 25);
                    grad.addColorStop(0, '#00f0ff');
                    grad.addColorStop(1, '#7000df');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.roundRect(x, y, barW, barH, 4);
                    ctx.fill();

                    // Value
                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = '11px Rajdhani';
                    ctx.textAlign = 'center';
                    ctx.fillText(val, x + barW/2, y - 4);

                    // Label
                    ctx.fillStyle = '#8888aa';
                    ctx.font = '10px Rajdhani';
                    ctx.fillText(label.slice(5), x + barW/2, H - 8);
                });
            }, [filteredHistory]);

            // Efficiency trend line
            useEffect(() => {
                const canvas = canvasLineRef.current;
                if (!canvas || filteredHistory.length === 0) return;
                const ctx = canvas.getContext('2d');
                const W = canvas.width = canvas.parentElement.clientWidth;
                const H = canvas.height = 120;
                ctx.clearRect(0, 0, W, H);

                const recent = [...filteredHistory].reverse().slice(0, 20).reverse();
                const effData = recent.map(h => h.efficiency || 0).filter(v => v > 0);
                if (effData.length < 2) return;

                const maxVal = Math.max(...effData, 1);
                const minVal = Math.min(...effData);
                const range = maxVal - minVal || 1;
                const padY = 20;
                const padX = 20;

                ctx.beginPath();
                ctx.strokeStyle = '#00f0ff';
                ctx.lineWidth = 2;
                effData.forEach((v, i) => {
                    const x = padX + (i / (effData.length - 1)) * (W - padX * 2);
                    const y = padY + (1 - (v - minVal) / range) * (H - padY * 2);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Dots
                effData.forEach((v, i) => {
                    const x = padX + (i / (effData.length - 1)) * (W - padX * 2);
                    const y = padY + (1 - (v - minVal) / range) * (H - padY * 2);
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fillStyle = '#00f0ff';
                    ctx.fill();
                });

                // Axis labels
                ctx.fillStyle = '#8888aa';
                ctx.font = '10px Rajdhani';
                ctx.textAlign = 'left';
                ctx.fillText(maxVal.toFixed(1), 2, padY + 4);
                ctx.fillText(minVal.toFixed(1), 2, H - padY + 12);
            }, [filteredHistory]);

            // Location bar chart
            useEffect(() => {
                const canvas = canvasLocRef.current;
                if (!canvas || filteredHistory.length === 0) return;
                const ctx = canvas.getContext('2d');
                const W = canvas.width = canvas.parentElement.clientWidth;

                const locMap = {};
                filteredHistory.forEach(h => {
                    const name = h.locationName || 'Unknown';
                    locMap[name] = (locMap[name] || 0) + 1;
                });
                const entries = Object.entries(locMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
                if (entries.length === 0) return;

                const H = canvas.height = entries.length * 30 + 10;
                ctx.clearRect(0, 0, W, H);
                const maxVal = Math.max(...entries.map(e => e[1]), 1);

                entries.forEach(([label, val], i) => {
                    const y = i * 30 + 5;
                    const barW = (val / maxVal) * (W - 100);

                    ctx.fillStyle = '#7000df';
                    ctx.beginPath();
                    ctx.roundRect(90, y, barW, 20, 4);
                    ctx.fill();

                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = '11px Rajdhani';
                    ctx.textAlign = 'right';
                    ctx.fillText(label.slice(0, 10), 85, y + 14);

                    ctx.textAlign = 'left';
                    ctx.fillText(val, 90 + barW + 5, y + 14);
                });
            }, [filteredHistory]);

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/80 backdrop-blur-sm">
                    <div className="glass-panel w-full sm:max-w-lg h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-2xl sm:rounded-2xl p-4 relative flex flex-col overflow-y-auto cyber-scroll">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-display text-cyber-primary flex items-center gap-2">
                                <Icon name="bar-chart-3" /> {t.statistics}
                            </h2>
                            <button onClick={onClose} title={t.close} className="text-cyber-dim hover:text-white"><Icon name="x" /></button>
                        </div>

                        {/* Period filter */}
                        <div className="flex gap-2 mb-4">
                            {['1M', '3M', '6M', 'ALL'].map(p => (
                                <button key={p} onClick={() => setPeriod(p)}
                                    className={`px-3 py-1 rounded text-xs font-bold font-tech uppercase transition-colors ${period === p ? 'bg-cyber-primary text-black' : 'bg-white/5 text-cyber-dim hover:text-white'}`}>
                                    {p}
                                </button>
                            ))}
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            <div className="glass-panel rounded-lg p-3 text-center">
                                <div className="text-2xl font-display text-white">{stats.count}</div>
                                <div className="text-xs text-cyber-dim">{t.totalSessions}</div>
                            </div>
                            <div className="glass-panel rounded-lg p-3 text-center">
                                <div className="text-2xl font-display text-cyber-primary">{stats.totalKwh}</div>
                                <div className="text-xs text-cyber-dim">{t.totalKwh}</div>
                            </div>
                            <div className="glass-panel rounded-lg p-3 text-center">
                                <div className="text-2xl font-display text-cyber-success">&yen;{stats.totalCost}</div>
                                <div className="text-xs text-cyber-dim">{t.totalCost}</div>
                            </div>
                            <div className="glass-panel rounded-lg p-3 text-center">
                                <div className="text-2xl font-display text-white">{stats.avgEfficiency}</div>
                                <div className="text-xs text-cyber-dim">{t.avgEfficiency}</div>
                            </div>
                        </div>

                        {filteredHistory.length === 0 ? (
                            <div className="text-center text-cyber-dim py-10">{t.noDataPeriod}</div>
                        ) : (
                            <>
                                {/* Monthly chart */}
                                <div className="mb-4">
                                    <h3 className="text-sm font-bold text-cyber-dim mb-2 uppercase">{t.monthlyCharges}</h3>
                                    <div className="glass-panel rounded-lg p-2"><canvas ref={canvasBarRef}></canvas></div>
                                </div>

                                {/* Efficiency trend */}
                                <div className="mb-4">
                                    <h3 className="text-sm font-bold text-cyber-dim mb-2 uppercase">{t.efficiencyTrend}</h3>
                                    <div className="glass-panel rounded-lg p-2"><canvas ref={canvasLineRef}></canvas></div>
                                </div>

                                {/* Location chart */}
                                <div className="mb-4">
                                    <h3 className="text-sm font-bold text-cyber-dim mb-2 uppercase">{t.byLocation}</h3>
                                    <div className="glass-panel rounded-lg p-2"><canvas ref={canvasLocRef}></canvas></div>
                                </div>
                            </>
                        )}

                        <button onClick={onClose} className="w-full py-3 mt-2 bg-cyber-dark border border-cyber-dim text-cyber-dim font-bold rounded-xl uppercase tracking-widest hover:text-white hover:border-white transition-colors">
                            {t.close}
                        </button>
                    </div>
                </div>
            );
        };

        // --- CSV Export ---
        const exportCSV = (history, settings, lang, t) => {
            const capacity = settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY;
            const rate = settings.electricityRate || DEFAULT_ELECTRICITY_RATE;
            const BOM = '\uFEFF';
            const headers = CSV_HEADERS[lang];
            const rows = history.map(h => {
                const kwh = calcChargedKwh(capacity, h.startBattery || 0, h.endBattery || h.batteryAfter || 0);
                const cost = calcCost(kwh, rate);
                const duration = h.startTime && h.endTime ? calcDurationMinutes(h.startTime, h.endTime) : 0;
                const speed = calcChargeSpeed(kwh, duration);
                return [
                    h.startTime ? formatDate(h.startTime) : formatDate(h.timestamp),
                    h.startTime || '',
                    h.endTime || '',
                    h.odometer || '',
                    h.startBattery || h.battery || '',
                    h.endBattery || h.batteryAfter || '',
                    h.startRange || '',
                    h.endRange || '',
                    kwh.toFixed(1),
                    cost,
                    formatDuration(duration),
                    speed.toFixed(1),
                    h.efficiency || '',
                    h.locationName || ''
                ].map(v => `"${v}"`).join(',');
            });
            const csv = BOM + headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ev-gravity-log-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(t.toastCsvExported, 'success');
        };

        // --- Settings Modal (expanded) ---
        const SettingsModal = ({ isOpen, onClose, settings, setSettings, locations, setLocations, offlineQueue, t }) => {
            const [newLoc, setNewLoc] = useState({ name: '', voltage: 200, amperage: 15, kw: 3.0 });
            const [editingLocId, setEditingLocId] = useState(null);

            useEffect(() => { lucide.createIcons(); });

            const handleSaveLocation = () => {
                if (!newLoc.name) return;
                if (editingLocId) {
                    setLocations(locations.map(l => l.id === editingLocId ? { ...newLoc, id: editingLocId } : l));
                    setEditingLocId(null);
                } else {
                    setLocations([...locations, { ...newLoc, id: generateId() }]);
                }
                setNewLoc({ name: '', voltage: 200, amperage: 15, kw: 3.0 });
            };

            const startEdit = (loc) => {
                setNewLoc({ name: loc.name, voltage: loc.voltage, amperage: loc.amperage, kw: loc.kw });
                setEditingLocId(loc.id);
            };

            const cancelEdit = () => {
                setNewLoc({ name: '', voltage: 200, amperage: 15, kw: 3.0 });
                setEditingLocId(null);
            };

            const removeLocation = (id) => setLocations(locations.filter(l => l.id !== id));

            const updateSetting = (key, value) => {
                setSettings(prev => ({ ...prev, [key]: value }));
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="glass-panel w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl p-6 relative cyber-scroll">
                        <button onClick={onClose} className="absolute top-4 right-4 text-cyber-dim hover:text-white"><Icon name="x" /></button>
                        <h2 className="text-xl font-display text-cyber-primary mb-6 flex items-center gap-2">
                            <Icon name="settings" /> {t.settings}
                        </h2>

                        {/* Vehicle Settings */}
                        <div className="mb-6">
                            <h3 className="text-sm font-bold text-white mb-3 flex items-center gap-2"><Icon name="car" size={16} /> {t.vehicle}</h3>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-cyber-dim text-xs block mb-1">{t.batteryCapacity}</label>
                                    <input type="number" value={settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY}
                                        onChange={e => updateSetting('batteryCapacity', Number(e.target.value))}
                                        className="w-full glass-input rounded p-2 text-sm" />
                                </div>
                                <div>
                                    <label className="text-cyber-dim text-xs block mb-1">{t.electricityRate}</label>
                                    <input type="number" value={settings.electricityRate || DEFAULT_ELECTRICITY_RATE} step="0.01"
                                        onChange={e => updateSetting('electricityRate', Number(e.target.value))}
                                        className="w-full glass-input rounded p-2 text-sm" />
                                </div>
                                <div className="flex items-center gap-3">
                                    <input type="checkbox" checked={settings.useNightRate || false}
                                        onChange={e => updateSetting('useNightRate', e.target.checked)}
                                        className="w-4 h-4 accent-cyber-primary" />
                                    <label className="text-cyber-dim text-xs">{t.nightRate}</label>
                                    {settings.useNightRate && (
                                        <input type="number" value={settings.nightRate || DEFAULT_NIGHT_RATE} step="0.01"
                                            onChange={e => updateSetting('nightRate', Number(e.target.value))}
                                            className="glass-input rounded p-2 text-sm w-24 ml-auto" />
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Charging Locations */}
                        <div className="mb-6">
                            <h3 className="text-sm font-bold text-white mb-2 flex items-center gap-2"><Icon name="map-pin" size={16} /> {t.chargingLocations}</h3>
                            <div className="space-y-2 mb-4">
                                {locations.map(loc => (
                                    <div key={loc.id} className={`flex justify-between items-center bg-white/5 p-2 rounded border transition-colors ${editingLocId === loc.id ? 'border-cyber-primary bg-cyber-primary/10' : 'border-white/10'}`}>
                                        <div>
                                            <div className="font-bold text-cyber-primary">{loc.name}</div>
                                            <div className="text-xs text-cyber-dim">{loc.voltage}V / {loc.amperage}A / {loc.kw}kW</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => startEdit(loc)} title={t.editLocation} className="text-cyber-dim hover:text-white"><Icon name="edit-2" size={16} /></button>
                                            <button onClick={() => removeLocation(loc.id)} title={t.delete} className="text-cyber-accent hover:text-white"><Icon name="trash-2" size={16} /></button>
                                        </div>
                                    </div>
                                ))}
                                {locations.length === 0 && <div className="text-xs text-cyber-dim italic">{t.noLocations}</div>}
                            </div>

                            <div className="bg-black/40 p-3 rounded border border-white/10">
                                <div className="text-xs text-cyber-dim mb-2 uppercase">{editingLocId ? t.editLocation : t.addNewLocation}</div>
                                <input type="text" placeholder="Name (e.g. Home)" value={newLoc.name} onChange={e => setNewLoc({ ...newLoc, name: e.target.value })} className="w-full glass-input rounded p-2 mb-2 text-sm" />
                                <div className="grid grid-cols-3 gap-2 mb-2">
                                    <input type="number" placeholder="V" value={newLoc.voltage} onChange={e => setNewLoc({ ...newLoc, voltage: Number(e.target.value) })} className="glass-input rounded p-2 text-sm" />
                                    <input type="number" placeholder="A" value={newLoc.amperage} onChange={e => setNewLoc({ ...newLoc, amperage: Number(e.target.value) })} className="glass-input rounded p-2 text-sm" />
                                    <input type="number" placeholder="kW" value={newLoc.kw} onChange={e => setNewLoc({ ...newLoc, kw: Number(e.target.value) })} className="glass-input rounded p-2 text-sm" />
                                </div>
                                <button onClick={handleSaveLocation} className="w-full py-2 bg-cyber-dark text-cyber-primary border border-cyber-primary rounded hover:bg-cyber-primary hover:text-black transition-colors text-sm font-bold uppercase mb-1">
                                    {editingLocId ? t.updateLocation : t.addLocation}
                                </button>
                                {editingLocId && <button onClick={cancelEdit} className="w-full py-1 text-xs text-cyber-dim hover:text-white underline">{t.cancelEdit}</button>}
                            </div>
                        </div>

                        {/* GAS URL */}
                        <div className="mb-6">
                            <label className="block text-sm text-cyber-dim mb-2">{t.gasUrl}</label>
                            <input type="text" value={settings.gasUrl || ''} onChange={(e) => updateSetting('gasUrl', e.target.value)}
                                placeholder="https://script.google.com/..."
                                className="w-full bg-cyber-black/50 border border-cyber-glassBorder rounded p-3 text-white focus:border-cyber-primary focus:outline-none text-sm" />
                        </div>

                        {/* Offline Queue Status */}
                        {offlineQueue.length > 0 && (
                            <div className="mb-6 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                                <div className="text-yellow-400 text-sm font-bold flex items-center gap-2">
                                    <Icon name="wifi-off" size={14} /> {t.offlineQueue}: {offlineQueue.length} {t.pendingItems}
                                </div>
                                <p className="text-xs text-cyber-dim mt-1">{t.autoSendOnline}</p>
                            </div>
                        )}

                        <div className="flex justify-end">
                            <button onClick={onClose} className="bg-cyber-primary text-black font-bold py-2 px-6 rounded hover:bg-white transition-colors">
                                {t.done}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- History List (improved) ---
        const HistoryList = ({ isOpen, onClose, history, onDelete, onEdit, onDeleteAll, onDeleteMany, settings, onExportCSV, t }) => {
            const [selectedIds, setSelectedIds] = useState([]);
            const [locationFilter, setLocationFilter] = useState('');

            useEffect(() => {
                if (!isOpen) setSelectedIds([]);
                lucide.createIcons();
            }, [isOpen, history]);
            useEffect(() => { lucide.createIcons(); });

            const capacity = settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY;
            const rate = settings.electricityRate || DEFAULT_ELECTRICITY_RATE;

            const allLocations = useMemo(() => {
                const locs = new Set();
                history.forEach(h => { if (h.locationName) locs.add(h.locationName); });
                return [...locs];
            }, [history]);

            const filteredHistory = useMemo(() => {
                if (!locationFilter) return history;
                return history.filter(h => h.locationName === locationFilter);
            }, [history, locationFilter]);

            const toggleSelect = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]);
            const handleSelectAll = () => {
                if (selectedIds.length === filteredHistory.length) setSelectedIds([]);
                else setSelectedIds(filteredHistory.map(h => h.id));
            };
            const executeDeleteSelected = () => { if (selectedIds.length > 0) { onDeleteMany(selectedIds); setSelectedIds([]); } };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/80 backdrop-blur-sm transition-all">
                    <div className="glass-panel w-full sm:max-w-md h-[85vh] sm:h-auto sm:max-h-[85vh] rounded-t-2xl sm:rounded-2xl p-6 relative flex flex-col">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-xl font-display text-cyber-primary flex items-center gap-2">
                                <Icon name="history" /> {t.history}
                            </h2>
                            <div className="flex gap-2 items-center">
                                {history.length > 0 && (
                                    <button onClick={onExportCSV} className="text-xs text-cyber-primary border border-cyber-primary px-2 py-1 rounded hover:bg-cyber-primary/10 flex items-center gap-1">
                                        <Icon name="download" size={12} /> {t.csv}
                                    </button>
                                )}
                                {selectedIds.length > 0 ? (
                                    <button onClick={executeDeleteSelected} className="text-xs text-cyber-accent border border-cyber-accent px-2 py-1 rounded hover:bg-cyber-accent/10 flex items-center gap-1">
                                        <Icon name="trash-2" size={12} /> Delete ({selectedIds.length})
                                    </button>
                                ) : (
                                    history.length > 0 && (
                                        <button onClick={onDeleteAll} className="text-xs text-cyber-dim border border-cyber-dim px-2 py-1 rounded hover:bg-white/10">{t.deleteAll}</button>
                                    )
                                )}
                                <button onClick={onClose} title={t.close} className="text-cyber-dim hover:text-white"><Icon name="x" /></button>
                            </div>
                        </div>

                        {/* Location filter */}
                        {allLocations.length > 0 && (
                            <div className="mb-2">
                                <select value={locationFilter} onChange={e => setLocationFilter(e.target.value)}
                                    className="glass-input rounded p-1 text-xs w-full appearance-none">
                                    <option value="">{t.allLocations}</option>
                                    {allLocations.map(loc => <option key={loc} value={loc}>{loc}</option>)}
                                </select>
                            </div>
                        )}

                        {filteredHistory.length > 0 && (
                            <div className="flex items-center gap-2 mb-2 px-1">
                                <input type="checkbox" checked={filteredHistory.length > 0 && selectedIds.length === filteredHistory.length}
                                    onChange={handleSelectAll} className="w-4 h-4 rounded border-cyber-dim bg-transparent accent-cyber-primary cursor-pointer" />
                                <span className="text-xs text-cyber-dim">{t.selectAll} ({filteredHistory.length})</span>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto cyber-scroll pr-2 space-y-3 pb-4">
                            {filteredHistory.length === 0 ? (
                                <div className="text-center text-cyber-dim py-10">{t.noRecords}</div>
                            ) : (
                                filteredHistory.map(item => {
                                    const kwh = calcChargedKwh(capacity, item.startBattery || 0, item.endBattery || item.batteryAfter || 0);
                                    const cost = calcCost(kwh, rate);
                                    const duration = item.startTime && item.endTime ? calcDurationMinutes(item.startTime, item.endTime) : 0;
                                    const speed = calcChargeSpeed(kwh, duration);
                                    const badge = getChargeSpeedBadge(speed);

                                    return (
                                        <div key={item.id} className={`bg-white/5 rounded-lg p-3 border-l-2 transition-colors ${selectedIds.includes(item.id) ? 'border-cyber-primary bg-cyber-primary/10' : 'border-cyber-dim'}`}>
                                            <div className="flex justify-between items-start mb-1">
                                                <div className="flex items-start gap-3 flex-1 min-w-0">
                                                    <input type="checkbox" checked={selectedIds.includes(item.id)} onChange={() => toggleSelect(item.id)}
                                                        className="mt-1 w-4 h-4 rounded border-cyber-dim bg-transparent accent-cyber-primary cursor-pointer flex-shrink-0" />
                                                    <div className="min-w-0">
                                                        <div className="text-xs text-cyber-dim">{item.startTime ? formatDate(item.startTime) : formatDate(item.timestamp)}</div>
                                                        <div className="flex items-baseline gap-2 mt-1">
                                                            <span className="text-lg font-display text-white">{item.startRange || '-'} <Icon name="arrow-right" size={12} className="inline" /> {item.endRange || '-'}</span>
                                                            <span className="text-xs text-cyber-dim">km</span>
                                                        </div>
                                                        <div className="text-sm font-tech text-white mt-1">
                                                            {t.battPct}: {item.battery || item.startBattery}% <Icon name="arrow-right" size={12} className="inline" /> {item.batteryAfter || item.endBattery}%
                                                        </div>
                                                        {/* New: kWh, Cost, Duration, Speed */}
                                                        <div className="flex gap-3 mt-1 text-xs">
                                                            <span className="text-cyber-primary">{kwh.toFixed(1)}kWh</span>
                                                            <span className="text-cyber-success">&yen;{cost}</span>
                                                            {duration > 0 && <span className="text-white">{formatDuration(duration)}</span>}
                                                            {speed > 0 && (
                                                                <span style={{ color: badge.color }}>{badge.emoji} {speed.toFixed(1)}kW</span>
                                                            )}
                                                        </div>
                                                        {item.locationName && (
                                                            <div className="text-xs text-cyber-primary mt-1 flex items-center gap-1">
                                                                <Icon name="map-pin" size={10} /> {item.locationName}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 flex-shrink-0">
                                                    <button onClick={() => onEdit(item)} title={t.editSession} className="h-10 w-10 flex items-center justify-center bg-cyber-primary text-black rounded font-bold hover:bg-white transition-colors shadow-[0_0_10px_rgba(0,240,255,0.3)]">
                                                        <Icon name="edit-2" size={18} />
                                                    </button>
                                                    <button onClick={() => onDelete(item.id)} title={t.delete} className="h-10 w-10 flex items-center justify-center bg-cyber-dark border border-cyber-accent text-cyber-accent rounded hover:bg-cyber-accent hover:text-white transition-colors">
                                                        <Icon name="trash-2" size={18} />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>

                        <button onClick={onClose} className="w-full py-3 mt-4 bg-cyber-dark border border-cyber-dim text-cyber-dim font-bold rounded-xl uppercase tracking-widest hover:text-white hover:border-white transition-colors">
                            {t.close}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Edit Session Modal ---
        const EditSessionModal = ({ isOpen, onClose, item, onSave, t }) => {
            if (!isOpen || !item) return null;
            const [formData, setFormData] = useState({ ...item });

            useEffect(() => {
                setFormData({ ...item });
                setTimeout(() => lucide.createIcons(), 0);
            }, [item]);

            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
            const handleSave = () => { onSave(formData); onClose(); };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div className="glass-panel w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl p-6 relative cyber-scroll">
                        <button onClick={onClose} className="absolute top-4 right-4 text-cyber-dim hover:text-white"><Icon name="x" /></button>
                        <h2 className="text-xl font-display text-cyber-primary mb-6 flex items-center gap-2">
                            <Icon name="edit-2" /> {t.editSession}
                        </h2>

                        <div className="space-y-4">
                            <div className="mb-3">
                                <label className="text-cyber-dim text-xs font-tech uppercase mb-1 block">{t.start}</label>
                                <input type="datetime-local" value={formData.startTime || formData.timestamp || ''} onChange={(e) => handleChange('startTime', e.target.value)} className="glass-input rounded p-2 text-sm w-full" />
                            </div>
                            <div className="mb-3">
                                <label className="text-cyber-dim text-xs font-tech uppercase mb-1 block">{t.end}</label>
                                <input type="datetime-local" value={formData.endTime || ''} onChange={(e) => handleChange('endTime', e.target.value)} className="glass-input rounded p-2 text-sm w-full" />
                            </div>
                            <div className="mb-3">
                                <label className="text-cyber-dim text-xs font-tech uppercase mb-1 block">{t.odometer}</label>
                                <div className="flex items-center gap-1 glass-input rounded p-2">
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) - 100)} className="cyber-btn h-8 w-12 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-accent text-xs font-bold">-100</button>
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) - 10)} className="cyber-btn h-8 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-accent text-xs font-bold">-10</button>
                                    <input type="number" value={Number(formData.odometer || 0)} onChange={(e) => handleChange('odometer', Number(e.target.value))} className="flex-1 bg-transparent text-center text-lg font-display text-cyber-primary focus:outline-none" />
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) + 10)} className="cyber-btn h-8 w-10 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-primary text-xs font-bold">+10</button>
                                    <button onClick={() => handleChange('odometer', Number(formData.odometer || 0) + 100)} className="cyber-btn h-8 w-12 flex items-center justify-center rounded bg-cyber-dark/50 text-cyber-primary text-xs font-bold">+100</button>
                                </div>
                            </div>
                            <SmartNumberInput label={t.efficiency} value={Number(formData.efficiency)} unit="km/kWh" steps={[-1, -0.1, 0.1, 1]} min={0} max={20} onChange={(v) => handleChange('efficiency', v)} />
                            <div className="p-3 border border-cyber-glassBorder rounded-lg bg-white/5">
                                <div className="text-xs text-cyber-dim mb-2 uppercase tracking-widest">{t.startConditions}</div>
                                <SmartNumberInput label={t.battPct} value={Number(formData.startBattery || formData.battery || 0)} unit="%" onChange={(v) => handleChange('startBattery', v)} />
                                <SmartNumberInput label={t.range} value={Number(formData.startRange || 0)} unit="km" onChange={(v) => handleChange('startRange', v)} />
                            </div>
                            <div className="p-3 border border-cyber-glassBorder rounded-lg bg-white/5">
                                <div className="text-xs text-cyber-dim mb-2 uppercase tracking-widest">{t.endConditions}</div>
                                <SmartNumberInput label={t.battPct} value={Number(formData.endBattery || formData.batteryAfter || 0)} unit="%" onChange={(v) => handleChange('endBattery', v)} />
                                <SmartNumberInput label={t.range} value={Number(formData.endRange || 0)} unit="km" onChange={(v) => handleChange('endRange', v)} />
                            </div>
                            <div className="flex gap-2 mt-4">
                                <button onClick={onClose} className="flex-1 py-3 bg-cyber-dark border border-cyber-dim text-cyber-dim font-bold rounded-xl uppercase tracking-widest hover:text-white hover:border-white transition-colors">{t.cancel}</button>
                                <button onClick={handleSave} className="flex-[2] py-3 bg-cyber-primary text-black font-bold rounded-xl uppercase tracking-widest hover:bg-white transition-colors">{t.saveChanges}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [engine, setEngine] = useState(null);
            const [chargingSession, setChargingSession] = useState(null);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [completionRecord, setCompletionRecord] = useState(null);
            const [lang, setLang] = useState(() => localStorage.getItem(STORAGE_KEY_LANG) || 'en');
            const t = LANG[lang];

            // Common inputs
            const [odometer, setOdometer] = useState(10000);
            const [efficiency, setEfficiency] = useState(6.0);

            // Start Phase Inputs
            const [startTime, setStartTime] = useState(getLocalISOString());
            const [startBattery, setStartBattery] = useState(50);
            const [startRange, setStartRange] = useState(200);

            // End Phase Inputs
            const [endTime, setEndTime] = useState(getLocalISOString());
            const [endBattery, setEndBattery] = useState(80);
            const [endRange, setEndRange] = useState(350);

            const [locations, setLocations] = useState([]);
            const [selectedLocationId, setSelectedLocationId] = useState("");

            const [history, setHistory] = useState([]);
            const [settings, setSettings] = useState({
                gasUrl: PRE_CONFIGURED_GAS_URL,
                batteryCapacity: DEFAULT_BATTERY_CAPACITY,
                electricityRate: DEFAULT_ELECTRICITY_RATE,
                nightRate: DEFAULT_NIGHT_RATE,
                useNightRate: false,
            });
            const [offlineQueue, setOfflineQueue] = useState([]);

            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showStats, setShowStats] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [validationErrors, setValidationErrors] = useState({});
            const [updateAvailable, setUpdateAvailable] = useState(false);

            // Listen for SW update events
            useEffect(() => {
                const onReady = () => setUpdateAvailable(true);
                const onUpdated = (e) => {
                    showToast(`v${e.detail} available. Reload to update.`, 'info', 5000);
                    setUpdateAvailable(true);
                };
                window.addEventListener('sw-update-ready', onReady);
                window.addEventListener('sw-updated', onUpdated);
                return () => {
                    window.removeEventListener('sw-update-ready', onReady);
                    window.removeEventListener('sw-updated', onUpdated);
                };
            }, []);

            // Load from LocalStorage on mount
            useEffect(() => {
                // Check onboarding
                const onboardingDone = localStorage.getItem(STORAGE_KEY_ONBOARDING);
                if (!onboardingDone) setShowOnboarding(true);

                const savedSession = localStorage.getItem(STORAGE_KEY_SESSION);
                const savedHistory = localStorage.getItem(STORAGE_KEY_DATA);
                const savedSettings = localStorage.getItem(STORAGE_KEY_SETTINGS);
                const savedLocations = localStorage.getItem(STORAGE_KEY_LOCATIONS);
                const savedQueue = localStorage.getItem(STORAGE_KEY_QUEUE);

                if (savedSession) {
                    try { setChargingSession(JSON.parse(savedSession)); } catch (e) { console.error('Failed to parse session', e); }
                }
                if (savedHistory) {
                    try { setHistory(JSON.parse(savedHistory)); } catch (e) { console.error('Failed to parse history', e); }
                }
                if (savedSettings) {
                    try {
                        const parsed = JSON.parse(savedSettings);
                        // Migration: old format had just { gasUrl }
                        if (parsed.gasUrl && !parsed.batteryCapacity) {
                            setSettings(prev => ({ ...prev, gasUrl: parsed.gasUrl }));
                        } else {
                            setSettings(prev => ({ ...prev, ...parsed }));
                        }
                    } catch (e) { console.error('Failed to parse settings', e); }
                }
                if (savedLocations) {
                    try { setLocations(JSON.parse(savedLocations)); } catch (e) { console.error('Failed to parse locations', e); }
                }
                if (savedQueue) {
                    try { setOfflineQueue(JSON.parse(savedQueue)); } catch (e) { console.error('Failed to parse queue', e); }
                }
            }, []);

            // Hydrate end form defaults based on session
            useEffect(() => {
                const savedSession = localStorage.getItem(STORAGE_KEY_SESSION);
                const savedData = localStorage.getItem(STORAGE_KEY_DATA);

                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    setEndBattery(Math.min(session.startBattery + 20, 100));
                    setEndRange(session.startRange + 50);
                    setEndTime(getLocalISOString());
                } else {
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        if (parsed.length > 0) setOdometer(parsed[0].odometer);
                    }
                }
                lucide.createIcons();
            }, []);

            // Save language preference
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_LANG, lang);
            }, [lang]);

            // Save settings
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
            }, [settings]);

            // Save locations
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_LOCATIONS, JSON.stringify(locations));
            }, [locations]);

            // Save offline queue
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_QUEUE, JSON.stringify(offlineQueue));
            }, [offlineQueue]);

            // Online/offline queue retry
            useEffect(() => {
                const retryQueue = async () => {
                    if (offlineQueue.length === 0 || !navigator.onLine) return;
                    const gasUrl = settings.gasUrl;
                    if (!gasUrl) return;

                    const remaining = [];
                    for (const item of offlineQueue) {
                        try {
                            await fetch(gasUrl, {
                                method: 'POST', mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(item)
                            });
                        } catch (e) {
                            remaining.push(item);
                        }
                    }
                    setOfflineQueue(remaining);
                    if (remaining.length < offlineQueue.length) {
                        showToast(t.toastQueueSent.replace('{n}', offlineQueue.length - remaining.length), 'success');
                    }
                };

                window.addEventListener('online', retryQueue);
                // Also try on mount
                retryQueue();
                return () => window.removeEventListener('online', retryQueue);
            }, [offlineQueue, settings.gasUrl]);

            // Physics block spawners for Start phase
            useEffect(() => {
                if (!engine || chargingSession) return;
                const block = Bodies.rectangle(Math.random() * window.innerWidth, -50, 60, 40, {
                    restitution: 0.6, friction: 0.3, render: { fillStyle: getRandomColor() }
                });
                block.label = `${startBattery}%`;
                World.add(engine.world, block);
            }, [startBattery, engine, chargingSession]);

            useEffect(() => {
                if (!engine || chargingSession) return;
                const block = Bodies.rectangle(Math.random() * window.innerWidth, -50, 70, 40, {
                    restitution: 0.6, friction: 0.3, render: { fillStyle: getRandomColor() }
                });
                block.label = `${startRange}km`;
                World.add(engine.world, block);
            }, [startRange, engine, chargingSession]);

            useEffect(() => {
                if (!engine || chargingSession) return;
                const block = Bodies.rectangle(Math.random() * window.innerWidth, -50, 80, 40, {
                    restitution: 0.6, friction: 0.3, render: { fillStyle: getRandomColor() }
                });
                block.label = `${odometer}km`;
                World.add(engine.world, block);
            }, [odometer, engine, chargingSession]);

            // Physics block spawners for End phase
            useEffect(() => {
                if (!engine || !chargingSession) return;
                const block = Bodies.rectangle(Math.random() * window.innerWidth, -50, 60, 40, {
                    restitution: 0.6, friction: 0.3, render: { fillStyle: getRandomColor() }
                });
                block.label = `${endBattery}%`;
                World.add(engine.world, block);
            }, [endBattery, engine, chargingSession]);

            useEffect(() => {
                if (!engine || !chargingSession) return;
                const block = Bodies.rectangle(Math.random() * window.innerWidth, -50, 70, 40, {
                    restitution: 0.6, friction: 0.3, render: { fillStyle: getRandomColor() }
                });
                block.label = `${endRange}km`;
                World.add(engine.world, block);
            }, [endRange, engine, chargingSession]);

            // Physics spawner helper
            const spawnDataBlock = (data) => {
                if (!engine) return;
                const body = Bodies.rectangle(
                    Math.random() * (window.innerWidth - 100) + 50, -100, 60, 60, {
                    restitution: 0.8, friction: 0.005, density: 0.04,
                    chamfer: { radius: 10 },
                    render: { fillStyle: getRandomColor(), strokeStyle: '#ffffff', lineWidth: 2, opacity: 0.9 }
                });
                Body.setVelocity(body, { x: (Math.random() - 0.5) * 5, y: 5 });
                Body.setAngularVelocity(body, (Math.random() - 0.5) * 0.2);
                World.add(engine.world, body);
            };

            // Initial physics population
            const hasSpawnedRef = useRef(false);
            useEffect(() => {
                if (engine && history.length > 0 && !hasSpawnedRef.current) {
                    hasSpawnedRef.current = true;
                    history.slice(0, 5).forEach((item, i) => {
                        setTimeout(() => spawnDataBlock(item), i * 200);
                    });
                }
            }, [engine, history]);

            // --- Validation ---
            const validateCompletion = () => {
                const errors = {};
                if (chargingSession) {
                    if (endBattery < chargingSession.startBattery) {
                        errors.endBattery = true;
                        showToast(t.valEndBattery, 'error');
                    }
                    if (endRange < chargingSession.startRange) {
                        errors.endRange = true;
                        showToast(t.valEndRange, 'error');
                    }
                    if (new Date(endTime) <= new Date(chargingSession.startTime)) {
                        errors.endTime = true;
                        showToast(t.valEndTime, 'error');
                    }
                    const durationHours = (new Date(endTime) - new Date(chargingSession.startTime)) / 3600000;
                    if (durationHours > MAX_CHARGE_HOURS) {
                        errors.endTime = true;
                        showToast(t.valDuration.replace('{n}', MAX_CHARGE_HOURS), 'error');
                    }
                }
                setValidationErrors(errors);
                return Object.keys(errors).length === 0;
            };

            // --- Handlers ---
            const handleStartCharging = () => {
                const loc = locations.find(l => l.id === selectedLocationId) || {};
                const session = {
                    id: generateId(),
                    startTime, odometer, startBattery, startRange, efficiency,
                    startedAt: Date.now(),
                    locationName: loc.name || "",
                    voltage: loc.voltage || "",
                    amperage: loc.amperage || "",
                    kw: loc.kw || ""
                };
                setChargingSession(session);
                localStorage.setItem(STORAGE_KEY_SESSION, JSON.stringify(session));
                setEndBattery(100);
                setEndRange(100);
                setEndTime(getLocalISOString());
                setValidationErrors({});
            };

            const handleCompleteCharging = async () => {
                if (!validateCompletion()) return;
                setIsSaving(true);

                const capacity = settings.batteryCapacity || DEFAULT_BATTERY_CAPACITY;
                const rate = settings.electricityRate || DEFAULT_ELECTRICITY_RATE;
                const chargedKwh = calcChargedKwh(capacity, chargingSession.startBattery, endBattery);
                const cost = calcCost(chargedKwh, rate);
                const duration = calcDurationMinutes(chargingSession.startTime, endTime);
                const chargeSpeed = calcChargeSpeed(chargedKwh, duration);

                const finalRecord = {
                    ...chargingSession,
                    endTime, endBattery, endRange,
                    chargedKwh: parseFloat(chargedKwh.toFixed(1)),
                    cost, duration: Math.round(duration),
                    chargeSpeed: parseFloat(chargeSpeed.toFixed(1)),
                };

                // Save to History
                const newHistory = [finalRecord, ...history];
                setHistory(newHistory);
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));

                // Clear Session
                setChargingSession(null);
                localStorage.removeItem(STORAGE_KEY_SESSION);

                // Initialize next start defaults
                setStartBattery(endBattery);
                setStartRange(endRange);
                setOdometer(finalRecord.odometer);
                setStartTime(getLocalISOString());
                setValidationErrors({});

                // Physics Reward (enhanced: spawn 15 blocks)
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => spawnDataBlock(finalRecord), i * 80);
                }

                // Show completion summary
                setCompletionRecord(finalRecord);

                // Send to GAS
                const gasUrl = settings.gasUrl;
                if (gasUrl) {
                    const payload = {
                        startTime: finalRecord.startTime || "",
                        endTime: finalRecord.endTime || "",
                        odometer: String(finalRecord.odometer || ""),
                        efficiency: String(finalRecord.efficiency || ""),
                        startBattery: String(finalRecord.startBattery || ""),
                        endBattery: String(finalRecord.endBattery || ""),
                        startRange: String(finalRecord.startRange || ""),
                        endRange: String(finalRecord.endRange || ""),
                        locationName: String(finalRecord.locationName || ""),
                        voltage: String(finalRecord.voltage || ""),
                        amperage: String(finalRecord.amperage || ""),
                        kw: String(finalRecord.kw || ""),
                        chargedKwh: String(finalRecord.chargedKwh || ""),
                        cost: String(finalRecord.cost || ""),
                        duration: String(finalRecord.duration || ""),
                        chargeSpeed: String(finalRecord.chargeSpeed || ""),
                    };

                    try {
                        await fetch(gasUrl, {
                            method: 'POST', mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        showToast(t.toastSavedSent, 'success');
                    } catch (e) {
                        console.error("GAS Error", e);
                        // Queue for offline retry
                        setOfflineQueue(prev => [...prev, payload]);
                        showToast(t.toastSavedQueued, 'info');
                    }
                } else {
                    showToast(t.toastSessionSaved, 'success');
                }

                setTimeout(() => setIsSaving(false), 500);
            };

            const handleDelete = (id) => {
                if (confirm(t.confirmDelete)) {
                    const newHistory = history.filter(item => item.id !== id);
                    setHistory(newHistory);
                    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));
                }
            };

            const handleDeleteAll = () => {
                if (confirm(t.confirmDeleteAll)) {
                    setHistory([]);
                    localStorage.removeItem(STORAGE_KEY_DATA);
                }
            };

            const handleDeleteMany = (ids) => {
                if (confirm(t.confirmDeleteN.replace('{n}', ids.length))) {
                    const newHistory = history.filter(item => !ids.includes(item.id));
                    setHistory(newHistory);
                    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));
                }
            };

            const handleUpdateSession = (updatedItem) => {
                const newHistory = history.map(item => item.id === updatedItem.id ? updatedItem : item);
                setHistory(newHistory);
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newHistory));
                setEditingItem(null);
            };

            const handleCancelSession = () => {
                if (confirm(t.confirmCancelSession)) {
                    setChargingSession(null);
                    localStorage.removeItem(STORAGE_KEY_SESSION);
                    setValidationErrors({});
                }
            };

            const handleOnboardingComplete = (vehicleSettings) => {
                setShowOnboarding(false);
                setSettings(prev => ({
                    ...prev,
                    batteryCapacity: vehicleSettings.batteryCapacity,
                    electricityRate: vehicleSettings.electricityRate,
                    nightRate: vehicleSettings.nightRate,
                    useNightRate: vehicleSettings.useNightRate,
                    gasUrl: vehicleSettings.gasUrl,
                }));
                showToast(t.toastWelcome, 'success');
            };

            return (
                <>
                    <PhysicsBackground onEngineReady={setEngine} />

                    <div className="relative z-10 w-full h-screen flex flex-col pointer-events-none">

                        {/* Header */}
                        <header className="p-3 flex justify-between items-center pointer-events-auto">
                            <h1 className="text-2xl font-display text-white italic tracking-tighter drop-shadow-lg">
                                EV<span className="text-cyber-primary">GRAVITY</span>
                            </h1>
                            <div className="flex gap-2 items-center">
                                <button onClick={() => setLang(lang === 'en' ? 'ja' : 'en')}
                                    title="Language / 言語"
                                    className="glass-panel rounded-full px-2 py-1 text-xs font-bold font-tech flex items-center gap-0.5 hover:bg-white/10 transition">
                                    <span className={lang === 'en' ? 'text-cyber-primary' : 'text-cyber-dim'}>EN</span>
                                    <span className="text-cyber-dim">/</span>
                                    <span className={lang === 'ja' ? 'text-cyber-primary' : 'text-cyber-dim'}>JP</span>
                                </button>
                                <button onClick={() => setShowStats(true)} title={t.statistics} className="glass-panel p-2 rounded-full text-cyber-primary hover:bg-white/10 transition">
                                    <Icon name="bar-chart-3" />
                                </button>
                                <button onClick={() => setShowHistory(true)} title={t.history} className="glass-panel p-2 rounded-full text-cyber-primary hover:bg-white/10 transition">
                                    <Icon name="history" />
                                </button>
                                <button onClick={() => setShowSettings(true)} title={t.settings} className="glass-panel p-2 rounded-full text-cyber-primary hover:bg-white/10 transition">
                                    <Icon name="settings" />
                                </button>
                            </div>
                        </header>

                        {/* Main Form Area */}
                        <main className="p-2 w-full max-w-md mx-auto pointer-events-auto overflow-y-auto pb-18" style={{ maxHeight: 'calc(100dvh - 100px)' }}>

                            {/* CASE 1: IDLE (Start Charging) */}
                            {!chargingSession && (
                                <div className="glass-panel rounded-2xl p-4 border-t border-cyber-glassBorder backdrop-blur-xl bg-black/40 shadow-2xl">
                                    <div className="flex items-center gap-2 mb-1 text-cyber-primary">
                                        <Icon name="plug-zap" />
                                        <h2 className="text-lg font-display">{t.startCharging}</h2>
                                    </div>

                                    <DateTimeInput label={t.startTime} value={startTime} onChange={setStartTime} />
                                    <Odometer value={odometer} onChange={setOdometer} t={t} />

                                    <div className="flex flex-col gap-2">
                                        <SmartNumberInput label={t.batteryPct} value={startBattery} unit="%" min={0} max={100} onChange={setStartBattery} />
                                        <SmartNumberInput label={t.rangeKm} value={startRange} unit="km" steps={[-10, -1, 1, 10]} min={0} max={1000} onChange={setStartRange} />
                                    </div>

                                    <SmartNumberInput label={t.efficiency} value={efficiency} unit="" steps={[-1, -0.1, 0.1, 1]} min={0} max={20} onChange={setEfficiency} />

                                    {/* Location Selector */}
                                    <div className="mb-2">
                                        <label className="text-cyber-dim text-xs font-tech uppercase tracking-wider pl-1 font-bold flex items-center gap-2">
                                            <Icon name="map-pin" size={12} /> {t.chargingLocation}
                                        </label>
                                        <div className="relative">
                                            <select value={selectedLocationId} onChange={(e) => setSelectedLocationId(e.target.value)}
                                                className="w-full glass-input rounded-lg p-3 text-cyber-primary appearance-none focus:outline-none bg-black/50">
                                                <option value="">{t.manualUnspecified}</option>
                                                {locations.map(loc => (
                                                    <option key={loc.id} value={loc.id}>{loc.name} ({loc.kw}kW)</option>
                                                ))}
                                            </select>
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-cyber-primary">
                                                <Icon name="chevron-down" size={16} />
                                            </div>
                                        </div>
                                    </div>

                                    <button onClick={handleStartCharging}
                                        className="w-full mt-4 py-4 rounded-xl font-display font-bold text-xl tracking-widest uppercase bg-gradient-to-r from-cyber-secondary to-cyber-accent text-white shadow-lg hover:shadow-cyber-accent/50 transition-all transform active:scale-95">
                                        {t.startCharging}
                                    </button>
                                </div>
                            )}

                            {/* CASE 2: ACTIVE (Live Charging Screen) */}
                            {chargingSession && (
                                <LiveChargingScreen
                                    session={chargingSession}
                                    settings={settings}
                                    endTime={endTime}
                                    setEndTime={setEndTime}
                                    endBattery={endBattery}
                                    setEndBattery={setEndBattery}
                                    endRange={endRange}
                                    setEndRange={setEndRange}
                                    onComplete={handleCompleteCharging}
                                    onCancel={handleCancelSession}
                                    isSaving={isSaving}
                                    validationErrors={validationErrors}
                                    t={t}
                                />
                            )}
                        </main>
                    </div>

                    {/* Modals */}
                    <SettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        settings={settings}
                        setSettings={setSettings}
                        locations={locations}
                        setLocations={setLocations}
                        offlineQueue={offlineQueue}
                        t={t}
                    />

                    <HistoryList
                        isOpen={showHistory}
                        onClose={() => setShowHistory(false)}
                        history={history}
                        onDelete={handleDelete}
                        onDeleteAll={handleDeleteAll}
                        onDeleteMany={handleDeleteMany}
                        onEdit={setEditingItem}
                        settings={settings}
                        onExportCSV={() => exportCSV(history, settings, lang, t)}
                        t={t}
                    />

                    <EditSessionModal
                        isOpen={!!editingItem}
                        onClose={() => setEditingItem(null)}
                        item={editingItem}
                        onSave={handleUpdateSession}
                        t={t}
                    />

                    <StatsDashboard
                        isOpen={showStats}
                        onClose={() => setShowStats(false)}
                        history={history}
                        settings={settings}
                        t={t}
                    />

                    {/* Completion Summary Overlay */}
                    {completionRecord && (
                        <CompletionSummary
                            record={completionRecord}
                            settings={settings}
                            onDismiss={() => setCompletionRecord(null)}
                            t={t}
                        />
                    )}

                    {/* Onboarding */}
                    {showOnboarding && (
                        <Onboarding
                            onComplete={handleOnboardingComplete}
                            setVehicleSettings={() => {}}
                            t={t}
                        />
                    )}

                    {/* Update Banner */}
                    {updateAvailable && (
                        <div className="fixed top-0 left-0 right-0 z-[110] flex items-center justify-center p-2 pointer-events-auto">
                            <div className="glass-panel rounded-lg px-4 py-2 flex items-center gap-3 border border-cyber-primary/30 shadow-[0_0_20px_rgba(0,240,255,0.15)]">
                                <span className="text-cyber-primary text-sm font-tech">{t.newVersionAvail}</span>
                                <button onClick={() => window.location.reload()}
                                    className="bg-cyber-primary text-black text-xs font-bold px-3 py-1 rounded hover:bg-white transition-colors">
                                    {t.update}
                                </button>
                                <button onClick={() => setUpdateAvailable(false)} className="text-cyber-dim hover:text-white text-xs">
                                    {t.later}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Toast Container */}
                    <ToastContainer />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(function(reg) {
    // Check for updates periodically
    setInterval(function() { reg.update(); }, 60 * 60 * 1000);

    // Detect waiting SW (new version ready)
    function onNewSW() {
      window.dispatchEvent(new CustomEvent('sw-update-ready'));
    }
    if (reg.waiting) { onNewSW(); }
    reg.addEventListener('updatefound', function() {
      var newWorker = reg.installing;
      newWorker.addEventListener('statechange', function() {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          onNewSW();
        }
      });
    });
  });

  // Listen for SW_UPDATED message (post-activate notification)
  navigator.serviceWorker.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'SW_UPDATED') {
      window.dispatchEvent(new CustomEvent('sw-updated', { detail: event.data.version }));
    }
  });
}
</script>
</body>

</html>
